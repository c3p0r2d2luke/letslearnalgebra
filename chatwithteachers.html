<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script>
  document.getElementById("saveNameButton").onclick = () => {
    const name = document.getElementById("nameInput").value.trim();
    if (!name) return alert("You gotta type something!");
    localStorage.setItem("username", name);
    document.getElementById("logBox").textContent = "Name saved: " + name;
  };
  </script>
  

  <script type="module">
    const SUPABASE_URL = "https://qjajtkdchvapthnidtwj.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const logBox = document.getElementById("logBox");
    const msgList = document.getElementById("messages");
    const msgInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendButton");
    const namePrompt = document.getElementById("namePrompt");
    const nameInput = document.getElementById("nameInput");
    const saveNameBtn = document.getElementById("saveNameButton");
    
    let username = localStorage.getItem("username") || "";
    let role = localStorage.getItem("role") || "User";
    let muted = JSON.parse(localStorage.getItem("muted") || "[]");
    let pinned = JSON.parse(localStorage.getItem("pinned") || "[]");
    
    function log(msg){
      if(role === "Admin"){
        const p = document.createElement("div");
        p.textContent = msg;
        logBox.appendChild(p);
        logBox.scrollTop = logBox.scrollHeight;
      }
    }
    
    function mkBtn(text, fn){
      const b = document.createElement("button");
      b.textContent = text;
      b.onclick = fn;
      return b;
    }
    
    function renderMessage(m){
      const li = document.createElement("li");
      li.textContent = `${m.username}: ${m.content}`;
      if(m.username === username) li.style.fontWeight = "bold";
      if(role === "Admin"){
        const div = document.createElement("div");
        div.className = "adminControls";
        div.appendChild(mkBtn("Delete", ()=> delMsg(m.id)));
        div.appendChild(mkBtn("Pin", ()=> pinMsg(m.id, m.content)));
        div.appendChild(mkBtn("Unpin", ()=> unpinMsg(m.id)));
        div.appendChild(mkBtn("Mute", ()=> muteUser(m.username)));
        div.appendChild(mkBtn("Unmute", ()=> unmuteUser(m.username)));
        div.appendChild(mkBtn("Promote", ()=> promoteUser(m.username)));
        div.appendChild(mkBtn("Demote", ()=> demoteUser(m.username)));
        li.appendChild(div);
      }
      msgList.appendChild(li);
      msgList.scrollTop = msgList.scrollHeight;
    }
    
    async function loadMessages(){
      msgList.innerHTML = "<li>Loading messages...</li>";
      const { data, error } = await client.from("messages").select("*").order("inserted_at", {ascending:true});
      if(error){ log("Load error: "+error.message); return; }
      msgList.innerHTML = "";
      data.forEach(renderMessage);
    }
    
    async function sendMessage(){
      const content = msgInput.value.trim();
      if(!content) return;
      const ip = await fetch("https://api.ipify.org").then(r=>r.text()).catch(()=> "unknown");
      await client.from("messages").insert({content, username, role, ip});
      msgInput.value = "";
    }
    
    async function delMsg(id){
      await client.from("messages").delete().eq("id", id);
      log("Deleted message "+id);
    }
    function pinMsg(id, content){
      if(!pinned.includes(id)) pinned.push(id);
      localStorage.setItem("pinned", JSON.stringify(pinned));
      log("Pinned: "+content);
    }
    function unpinMsg(id){
      pinned = pinned.filter(x=>x!==id);
      localStorage.setItem("pinned", JSON.stringify(pinned));
      log("Unpinned message "+id);
    }
    function muteUser(user){
      if(!muted.includes(user)) muted.push(user);
      localStorage.setItem("muted", JSON.stringify(muted));
      log("Muted "+user);
    }
    function unmuteUser(user){
      muted = muted.filter(x=>x!==user);
      localStorage.setItem("muted", JSON.stringify(muted));
      log("Unmuted "+user);
    }
    function promoteUser(user){
      log("Promoted "+user+" (placeholder, manual in db)");
    }
    function demoteUser(user){
      log("Demoted "+user+" (placeholder, manual in db)");
    }
    
    // realtime updates
    client.channel("room")
      .on("postgres_changes", {event:"INSERT", schema:"public", table:"messages"}, payload=>{
        renderMessage(payload.new);
      })
      .on("postgres_changes", {event:"DELETE", schema:"public", table:"messages"}, payload=>{
        loadMessages();
      })
      .subscribe();
    
    async function init(){
      await loadMessages();
      log("Supabase loaded, messages synced.");
      if(username){
        namePrompt.style.display = "none";
        msgInput.disabled = false;
        sendBtn.disabled = false;
      }else{
        namePrompt.style.display = "block";
        msgInput.disabled = true;
        sendBtn.disabled = true;
      }
    }
    
    saveNameBtn.onclick = ()=>{
      const name = nameInput.value.trim();
      if(!name) return alert("Enter your real name.");
      username = name;
      localStorage.setItem("username", username);
      namePrompt.style.display = "none";
      msgInput.disabled = false;
      sendBtn.disabled = false;
      log("Name saved: "+username);
    };
    
    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey) sendMessage();
    });
    
    // manual clear name hotkey
    document.addEventListener("keydown", e=>{
      if(e.ctrlKey && e.altKey && e.shiftKey && e.key.toLowerCase()==="t"){
        localStorage.removeItem("username");
        localStorage.removeItem("role");
        alert("Name cleared!");
        location.reload();
      }
    });
    
    init();
    </script>
    


</body>
</html>
