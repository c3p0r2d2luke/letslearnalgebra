<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; } /* Discord blue for admin messages */
#messages li.manager { background:#43b581; font-weight:700; color:#fff; } /* green for managers */
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; } /* optional highlight effect */
</style>
</head>
<body>
<h1>Chat Room</h1>

<!-- Name prompt -->
<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<!-- Controls (message input + send) -->
<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<!-- messages list -->
<ul id="messages"></ul>

<!-- verbose admin log -->
<div id="logBox"></div>

<!--big long scripts-->
<script>
    /* ----------------------------------------------------------------------
       Supabase client
       ---------------------------------------------------------------------- */
    const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M"; // replace with your actual key
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    /* ----------------------------------------------------------------------
       DOM references
       ---------------------------------------------------------------------- */
    const input = document.getElementById("messageInput");
    const button = document.getElementById("sendButton");
    const messagesList = document.getElementById("messages");
    const logBox = document.getElementById("logBox");
    const namePrompt = document.getElementById("namePrompt");
    const nameInput = document.getElementById("nameInput");
    const saveNameBtn = document.getElementById("saveNameButton");
    
    /* ----------------------------------------------------------------------
       Local state
       ---------------------------------------------------------------------- */
    let username = localStorage.getItem("chatUsername") || "";
    let currentRole = localStorage.getItem("chatRole") || null;
    let isAdmin = false;
    let isManager = false;
    let messagesChannel = null;
    let userIp = "unknown";
    
    /* ----------------------------------------------------------------------
       Logging for admin
       ---------------------------------------------------------------------- */
    function log(msg, obj=null, level="info", context=null){
        const now = new Date();
        const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}.${now.getMilliseconds()}`;
        const colors = { info:"#0f0", warn:"#ff0", error:"#f00", debug:"#0ff" };
        const color = colors[level]||"#0f0";
        console.log(`[${timestamp}] ${level.toUpperCase()}:`, msg, obj);
        if(!isAdmin) return;
        const entry = document.createElement("div");
        entry.style.marginBottom="6px";
        entry.style.borderBottom="1px solid #333";
        entry.style.paddingBottom="4px";
        entry.innerHTML = `<div><strong style="color:${color}">[${timestamp}] ${level.toUpperCase()}</strong>${context ? `<em style="color:#aaa">(${context})</em>` : ""}</div><div style="margin-left:8px">${msg}</div>`;
        if(obj){
            const pre = document.createElement("pre");
            try { pre.textContent = JSON.stringify(obj,null,2); } catch(e){ pre.textContent = String(obj); }
            pre.style.background="#111"; pre.style.color="#0f0"; pre.style.padding="4px"; pre.style.borderRadius="4px"; pre.style.overflowX="auto"; pre.style.fontSize="11px"; pre.style.maxHeight="150px"; pre.style.overflowY="auto";
            entry.appendChild(pre);
        }
        const MAX_LOGS=200;
        if(logBox.children.length>MAX_LOGS) logBox.removeChild(logBox.firstChild);
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
    }
    
    /* ----------------------------------------------------------------------
       Save username (onboarding)
       ---------------------------------------------------------------------- */
    async function saveName() {
        const val = nameInput.value.trim();
        if(!val) return alert("Name required!");
        username = val;
        currentRole = "User"; // default
        try { localStorage.setItem("chatUsername", username); localStorage.setItem("chatRole", currentRole); } catch(e){}
        isAdmin = username.toLowerCase() === "frenchwizz"; // admin
        isManager = username.toLowerCase() !== "frenchwizz" && currentRole === "Manager";
        logBox.style.display = isAdmin ? "block":"none";
        namePrompt.style.display="none";
        input.disabled=false;
        button.disabled=false;
        await loadMessages();
    }
    
    /* ----------------------------------------------------------------------
       Autologin
       ---------------------------------------------------------------------- */
    document.addEventListener("DOMContentLoaded", ()=>{
        if(saveNameBtn) saveNameBtn.onclick=saveName;
        if(button) button.onclick=sendMessage;
        if(input) input.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
        
        const saved = localStorage.getItem("chatUsername");
        if(saved){
            username = saved;
            currentRole = localStorage.getItem("chatRole") || "User";
            isAdmin = username.toLowerCase()==="frenchwizz";
            isManager = !isAdmin && currentRole==="Manager";
            logBox.style.display = isAdmin ? "block" : "none";
            namePrompt.style.display="none";
            input.disabled=false;
            button.disabled=false;
            loadMessages().catch(e=>log("Error loading messages", e,"error"));
        } else {
            namePrompt.style.display="block";
            input.disabled=true;
            button.disabled=true;
        }
    });
    
    /* ----------------------------------------------------------------------
       Fetch IP
       ---------------------------------------------------------------------- */
    fetch("https://api.ipify.org?format=json").then(r=>r.json()).then(d=>{ userIp=d.ip; log("IP fetched: "+userIp); }).catch(()=>{ userIp="unknown"; log("Failed fetching IP","warn"); });
    
    /* ----------------------------------------------------------------------
       Load messages and subscribe
       ---------------------------------------------------------------------- */
    async function loadMessages(){
        if(!username) return;
        try {
            const { data, error } = await supabase.from("messages").select().order("inserted_at",{ascending:true});
            if(error) log("Failed loading messages",error,"error");
            else data.forEach(m=>addMessage(m));
        } catch(e){ log("Exception loading messages", e, "error"); }
    
        if(!messagesChannel){
            messagesChannel = supabase.channel("public:messages");
            messagesChannel.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>addMessage(payload.new));
            messagesChannel.on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},payload=>addMessage(payload.new));
            messagesChannel.subscribe().then(status=>log("Realtime status: "+status));
        }
    }
    
    /* ----------------------------------------------------------------------
       Render messages
       ---------------------------------------------------------------------- */
    function addMessage(msg){
        if(!msg || !msg.id) return;
        const li = document.createElement("li");
        li.id="msg-"+msg.id;
        const msgRole = msg.role||"User";
        const isMsgAdmin = msg.username==="Frenchwizz" || msgRole==="Admin";
        const displayName = msg.username==="Frenchwizz"?"Takeo":msg.username;
        if(isMsgAdmin) li.classList.add("admin");
        else if(msgRole==="Manager") li.classList.add("manager");
        li.innerHTML=`<div class="username">${displayName}</div><div class="content">${escapeHtml(msg.content||"")}</div><div class="timestamp">${msg.inserted_at?new Date(msg.inserted_at).toLocaleTimeString():"?"}</div><span class="userIp">${msg.ip||"unknown"}</span>${isAdmin?"<div class='adminControls'></div>":""}`;
        messagesList.appendChild(li);
        messagesList.scrollTop=messagesList.scrollHeight;
        if(isAdmin || isManager) createControls(li,msg);
    }
    
    function escapeHtml(str=""){ return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    
    /* ----------------------------------------------------------------------
       Send message
       ---------------------------------------------------------------------- */
    async function sendMessage(){
        let text=input.value.replace(/\r/g,"").trim();
        if(!text) return;
        try {
            let res = await supabase.from("messages").insert({ content:text, username, ip:userIp, role:currentRole }).select();
            if(res.error) log("Failed sending message",res.error,"error");
            else if(Array.isArray(res.data)&&res.data[0]) addMessage(res.data[0]);
        } catch(e){ log("Exception sending message",e,"error"); }
        input.value="";
    }
    
    /* ----------------------------------------------------------------------
       Create admin/manager controls
       ---------------------------------------------------------------------- */
    function createControls(li,msg){
        const div=li.querySelector(".adminControls");
        if(!div) return;
        div.style.display="none";
    
        const isViewerAdmin = isAdmin;
        const isViewerManager = isManager && !isAdmin;
    
        function addBtn(label,fn){ const b=document.createElement("button"); b.textContent=label; b.onclick=fn; div.appendChild(b); }
    
        if(isViewerAdmin){
            addBtn("Delete",async()=>{ await supabase.from("messages").delete().eq("id",msg.id); li.remove(); log(`Deleted msg ${msg.id}`); });
            addBtn("Edit",async()=>{ const t=prompt("Edit message",msg.content||""); if(t===null) return; await supabase.from("messages").update({content:t}).eq("id",msg.id); li.querySelector(".content").textContent=t; });
            addBtn("Change Name",async()=>{ const n=prompt("New username",msg.username); if(!n) return; await supabase.from("users").upsert({username:n}); await supabase.from("messages").update({username:n}).eq("username",msg.username); li.querySelector(".username").textContent=n; });
            addBtn("Toggle Block",async()=>{ alert("Block toggling placeholder"); });
            addBtn("Force Logout",async()=>{ alert(`Force logout ${msg.username}`); });
            addBtn("Mute 5min",()=>{ alert(`Muted ${msg.username}`); });
            addBtn("Export Chat",()=>{ alert("Export placeholder"); });
            addBtn("Delete by Keyword",()=>{ alert("Delete by keyword placeholder"); });
            addBtn("Delete User & Messages",()=>{ alert("NUKE placeholder"); });
            addBtn("User Info",()=>{ alert(`Username: ${msg.username}\nIP: ${msg.ip}\nRole: ${msg.role}`); });
            addBtn("Promote → Manager",async()=>{ await supabase.from("users").upsert({username:msg.username,role:"Manager"}); loadMessages(); });
            addBtn("Promote → Admin",async()=>{ await supabase.from("users").upsert({username:msg.username,role:"Admin"}); loadMessages(); });
            addBtn("Demote → User",async()=>{ await supabase.from("users").upsert({username:msg.username,role:"User"}); loadMessages(); });
        } else if(isViewerManager){
            addBtn("Delete",async()=>{ await supabase.from("messages").delete().eq("id",msg.id); li.remove(); });
            addBtn("Edit",async()=>{ const t=prompt("Edit message",msg.content||""); if(t===null) return; await supabase.from("messages").update({content:t}).eq("id",msg.id); li.querySelector(".content").textContent=t; });
            addBtn("User Info",()=>{ alert(`Username: ${msg.username}\nIP: ${msg.ip}\nRole: ${msg.role}`); });
        }
    
        li.addEventListener("click",()=>{ div.style.display=div.style.display==="none"?"flex":"none"; });
        document.addEventListener("click",()=>{ div.style.display="none"; });
    }
    </script>
    
    

</body>
</html>
