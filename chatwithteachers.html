<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script>
const supabaseUrl="https://qjajtkdchvapthnidtwj.supabase.co",supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M",supabase=window.supabase.createClient("https://qjajtkdchvapthnidtwj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M"),input=document.getElementById("messageInput"),button=document.getElementById("sendButton"),messagesList=document.getElementById("messages"),logBox=document.getElementById("logBox"),namePrompt=document.getElementById("namePrompt"),nameInput=document.getElementById("nameInput"),saveNameBtn=document.getElementById("saveNameButton");let username=localStorage.getItem("chatUsername")||"",isAdmin=!1,currentRole=localStorage.getItem("chatRole")||null,savedUsernameForAutoLogin=!1,realtimeReady=!1,messagesChannel=null,userIp="unknown";function escapeHtml(e=""){return String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}function log(e,t=null,n="info",s=null){let a=new Date,r=`${a.toLocaleDateString()} ${a.toLocaleTimeString()}.${a.getMilliseconds()}`;console.log(`[${r}] ${n.toUpperCase()}${s?" ("+s+")":""}:`,e,t);try{parent.postMessage({type:"console",payload:{args:[e,t],level:n,context:s}},"*")}catch(o){console.warn("Failed to send log to parent:",o)}if(!isAdmin)return;let l=document.createElement("div");if(l.style.marginBottom="6px",l.style.borderBottom="1px solid #333",l.style.paddingBottom="4px",l.innerHTML=`<div><strong style="color:${({info:"#0f0",warn:"#ff0",error:"#f00",debug:"#0ff"})[n]||"#0f0"}">[${r}] ${n.toUpperCase()}</strong> ${s?`<em style="color:#aaa">(${s})</em>`:""}</div><div style="margin-left:8px">${escapeHtml(String(e))}</div>`,t){let i=document.createElement("pre");try{i.textContent=JSON.stringify(t,null,2)}catch(d){i.textContent=String(t)}i.style.background="#111",i.style.color="#0f0",i.style.padding="4px",i.style.borderRadius="4px",i.style.overflowX="auto",i.style.fontSize="11px",i.style.maxHeight="150px",i.style.overflowY="auto",l.appendChild(i)}logBox.children.length>200&&logBox.removeChild(logBox.firstChild),logBox.appendChild(l),logBox.scrollTop=logBox.scrollHeight}async function fetchOrCreateUserRecord(e){if(!e)return{username:e,role:"User"};try{let{data:t,error:n}=await supabase.from("users").select("username,role,blocked,forceLogout").eq("username",e).maybeSingle();if(n&&log("‚ùå Error fetching user record",n,"error","users"),t)return t.role||(t.role="User"),{username:t.username,role:t.role,blocked:!!t.blocked,forceLogout:!!t.forceLogout};{let s=await supabase.from("users").upsert({username:e,role:"User",blocked:!1,forceLogout:!1});return s.error&&log("‚ùå Error upserting default user",s.error,"error","users"),{username:e,role:"User",blocked:!1,forceLogout:!1}}}catch(a){return log("‚ùå Exception fetching/creating user",a,"error","users"),{username:e,role:"User"}}}async function saveName(){let e=nameInput.value.trim();if(!e)return alert("Name required!");isAdmin="Admin"==(currentRole="frenchwizz"===(username=e).toLowerCase()?"Admin":"User"),localStorage.setItem("chatUsername",username),localStorage.setItem("chatRole",currentRole),logBox.style.display=isAdmin?"block":"none",namePrompt.style.display="none",input.disabled=!1,button.disabled=!1,savedUsernameForAutoLogin=!0;try{await loadMessages()}catch(t){}sendToParent("nameSaved",{username,role:currentRole})}async function verifyRealtimeConnection(){try{let e=supabase.channel("debug-connection-"+Math.random().toString(36).slice(2,8));e.on("system",{event:"connected"},()=>{realtimeReady=!0,log("‚úÖ Realtime connection established",null,"info","realtime"),savedUsernameForAutoLogin&&enableUIAfterHandshake(),e.unsubscribe().catch(()=>{})}).subscribe()}catch(t){log("Realtime connection test failed",t,"error","realtime")}}function enableUIAfterHandshake(){input.disabled=!1,button.disabled=!1,username&&!messagesChannel&&(realtimeReady?loadMessages().catch(e=>log("Error loading messages after handshake",e,"error","messages")):setTimeout(enableUIAfterHandshake,1e3))}async function loadMessages(){if(username){try{let{data:e,error:t}=await supabase.from("messages").select("*").order("inserted_at",{ascending:!0});if(t){log("‚ùå Failed to load messages",t,"error","messages");return}if(!e||!Array.isArray(e))return;messagesList.innerHTML="";let n=JSON.parse(localStorage.getItem("pinnedMessages")||"[]");e.filter(e=>n.includes(e.id)).forEach(e=>addMessage(e,{treatAsPinnedLoad:!0})),e.filter(e=>!n.includes(e.id)).forEach(e=>addMessage(e))}catch(s){log("‚ùå Exception loading messages",s,"error","messages")}messagesChannel||(messagesChannel=supabase.channel("public:messages")).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},e=>addMessage(e.new)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},e=>addMessage(e.new)).on("postgres_changes",{event:"DELETE",schema:"public",table:"messages"},e=>{let t=document.getElementById("msg-"+e.old.id);t&&t.remove()}).subscribe(e=>log(`Realtime subscription status: ${e}`,null,"debug","messages"))}}function addMessage(e,t={}){if(!e||!e.id)return;let n=e.role||"User",s="Frenchwizz"===e.username?"Takeo":e.username||"Unknown",a="Frenchwizz"===e.username||"admin"===String(n).toLowerCase(),r=document.getElementById("msg-"+e.id);r&&r.remove();let o=document.createElement("li");o.id="msg-"+e.id,o.dataset.originalIndex||(o.dataset.originalIndex=messagesList.children.length),a?o.classList.add("admin"):"Manager"===n&&o.classList.add("manager");let l=a?e.content||"":escapeHtml(e.content||"");o.innerHTML=`
    <div class="username">${escapeHtml(s)}</div>
    <div class="content">${l}</div>
    <div class="timestamp">${e.inserted_at?new Date(e.inserted_at).toLocaleTimeString():"?"}</div>
    <span class="userIp">${escapeHtml(e.ip||"unknown")}</span>
    ${isAdmin||"Manager"===currentRole?'<div class="adminControls"></div>':""}
  `;let i=JSON.parse(localStorage.getItem("pinnedMessages")||"[]");if(t.treatAsPinnedLoad||i.includes(e.id)){o.dataset.pinned="true",o.style.border="2px solid red";let d=messagesList.querySelector("li");d?messagesList.insertBefore(o,d):messagesList.appendChild(o)}else messagesList.appendChild(o);messagesList.scrollTop=messagesList.scrollHeight,(isAdmin||"Manager"===currentRole)&&createAdminControls(o,e)}async function sendMessage(){let e=input.value.replace(/\r/g,"").trim();if(!e)return;let t=isAdmin?e:escapeHtml(e),n=currentRole?currentRole.charAt(0).toUpperCase()+currentRole.slice(1):"User";try{let s=await supabase.from("messages").insert({content:t,username,ip:userIp,role:n}).select();s.error?log("‚ùå Message failed to send",s.error,"error","messages"):Array.isArray(s.data)&&s.data[0]&&(addMessage(s.data[0]),log("‚úÖ Message sent successfully",null,"info","messages"))}catch(a){log("‚ùå Exception inserting message",a,"error","messages")}input.value=""}function createAdminControls(e,t){let n=e.querySelector(".adminControls");if(!n)return;n.style.display="none";let s=currentRole||"User";if("Admin"===s){let a=document.createElement("button");a.textContent="Delete",a.onclick=async()=>{if("true"===e.dataset.pinned){alert("Cannot delete a pinned message!");return}try{let{error:n}=await supabase.from("messages").delete().eq("id",t.id);n?log("‚ùå Failed to delete message",n,"error","admin"):(e.remove(),log(`üóë Deleted message id=${t.id}`,null,"warn","admin"))}catch(s){log("‚ùå Exception deleting message",s,"error","admin")}},n.appendChild(a);let r=document.createElement("button");r.textContent="Edit",r.onclick=async()=>{let n=prompt("Edit message:",t.content||"");if(null!==n)try{let{error:s}=await supabase.from("messages").update({content:n}).eq("id",t.id);if(s)log("‚ùå Failed editing message",s,"error","admin");else{let a=e.querySelector(".content");if(a){let r="Frenchwizz"===t.username||"admin"===String(t.role).toLowerCase();a.innerHTML=r?n:escapeHtml(n)}log(`‚úèÔ∏è Edited message id=${t.id}`,{newText:n},"info","admin")}}catch(o){log("‚ùå Exception editing message",o,"error","admin")}},n.appendChild(r);let o=document.createElement("button");o.textContent="Change Name",o.onclick=async()=>{let e=prompt("New username for "+t.username+":",t.username);if(e)try{await supabase.from("users").upsert({username:e,blocked:!1}),await supabase.from("messages").update({username:e}).eq("username",t.username),document.querySelectorAll("#messages li").forEach(n=>{let s=n.querySelector(".username");s&&s.textContent===t.username&&(s.textContent=e)}),log(`üîÅ Changed username ${t.username} ‚Üí ${e}`,null,"info","admin")}catch(n){log("‚ùå Failed to change name",n,"error","admin")}},n.appendChild(o);let l=document.createElement("button");l.textContent="Toggle Block",l.onclick=async()=>{if(!t.ip||"unknown"===t.ip){alert("Cannot block: user IP unknown.");return}try{let{data:e}=await supabase.from("blocked_ips").select("*").eq("ip",t.ip).maybeSingle();e?(await supabase.from("blocked_ips").delete().eq("ip",t.ip),alert(`${t.username}'s IP (${t.ip}) is now unblocked`),log(`üîì Unblocked IP ${t.ip} for ${t.username}`,null,"warn","admin")):(await supabase.from("blocked_ips").insert({ip:t.ip,username:t.username}),alert(`${t.username}'s IP (${t.ip}) is now blocked`),log(`üîí Blocked IP ${t.ip} for ${t.username}`,null,"warn","admin"))}catch(n){log("‚ùå Failed toggling IP block",n,"error","admin")}},n.appendChild(l);let i=document.createElement("button");i.textContent="Force Logout",i.onclick=async()=>{if(t.username===username){alert("You cannot force logout yourself.");return}try{await supabase.from("users").update({forceLogout:!0}).eq("username",t.username),alert(`${t.username} has been forced to log out.`),log(`üîå Forced logout for ${t.username}`,null,"warn","admin")}catch(e){log("‚ùå Failed to force logout",e,"error","admin")}},n.appendChild(i);let d=document.createElement("button");d.textContent="Mute 5min",d.onclick=()=>{let e=window.__mutedUsers=window.__mutedUsers||{};e[t.username]=Date.now()+3e5,alert(`${t.username} muted for 5 minutes`),log(`üîá Muted ${t.username} for 5 minutes`,null,"info","admin")},n.appendChild(d);let m=document.createElement("button");m.textContent="Export Chat",m.onclick=()=>{let e=Array.from(messagesList.querySelectorAll("li")).map(e=>({username:e.querySelector(".username")?.textContent||"",content:e.querySelector(".content")?.textContent||"",timestamp:e.querySelector(".timestamp")?.textContent||""})),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=document.createElement("a");n.href=URL.createObjectURL(t),n.download="chat.json",n.click(),log("\uD83D\uDCE6 Exported chat to chat.json",null,"info","admin")},n.appendChild(m);let c=document.createElement("button");c.textContent="Delete by Keyword",c.onclick=async()=>{let e=prompt("Enter keyword to delete:");if(e)try{let t=JSON.parse(localStorage.getItem("pinnedMessages")||"[]"),{data:n}=await supabase.from("messages").select("*"),s=(n||[]).filter(n=>String(n.content||"").includes(e)&&!t.includes(n.id)).map(e=>e.id);s.length&&await supabase.from("messages").delete().in("id",s),Array.from(messagesList.querySelectorAll("li")).forEach(t=>{(t.querySelector(".content")?.textContent||"").includes(e)&&"true"!==t.dataset.pinned&&t.remove()}),log(`üßπ Deleted messages containing "${e}" (skipped pinned)`,null,"warn","admin")}catch(a){log("‚ùå Mass delete failed",a,"error","admin")}},n.appendChild(c);let u=document.createElement("button");u.textContent="Delete User & Messages",u.onclick=async()=>{if(confirm(`Are you sure you want to delete ${t.username} and ALL their messages? This cannot be undone.`))try{await supabase.from("messages").delete().eq("username",t.username);let e=await supabase.from("users").delete().eq("username",t.username);e.error&&log("‚ö†Ô∏è Could not delete user row",e.error,"warn","admin"),document.querySelectorAll("#messages li").forEach(e=>{e.querySelector(".username")?.textContent===t.username&&e.remove()}),alert(`${t.username} and all their messages have been deleted.`),log(`üóë Deleted all messages by ${t.username}`,null,"warn","admin")}catch(n){log("‚ùå Failed to delete user and messages",n,"error","admin"),alert("Error deleting user and messages. See log.")}},n.appendChild(u);let g=document.createElement("button");g.textContent="User Info",g.onclick=()=>{alert(`Username: ${t.username}
IP: ${t.ip}
Message ID: ${t.id}
Role: ${t.role||"User"}`),log(`‚ÑπÔ∏è Shown info for ${t.username}`,null,"debug","admin")},n.appendChild(g);let p=document.createElement("button");p.textContent="Promote ‚Üí Manager",p.onclick=async()=>{try{await supabase.from("users").upsert({username:t.username,role:"Manager"}),log(`üëë Promoted ${t.username} to Manager`,null,"info","admin"),await loadMessages()}catch(e){log("‚ùå Promote failed",e,"error","admin")}},n.appendChild(p);let f=document.createElement("button");f.textContent="Promote ‚Üí Admin",f.onclick=async()=>{try{await supabase.from("users").upsert({username:t.username,role:"Admin"}),log(`üëë Promoted ${t.username} to Admin`,null,"info","admin"),await loadMessages()}catch(e){log("‚ùå Promote to Admin failed",e,"error","admin")}},n.appendChild(f);let y=document.createElement("button");y.textContent="Demote ‚Üí User",y.onclick=async()=>{try{await supabase.from("users").upsert({username:t.username,role:"User"}),log(`üîª Demoted ${t.username} to User`,null,"info","admin"),await loadMessages()}catch(e){log("‚ùå Demote failed",e,"error","admin")}},n.appendChild(y)}let h=document.createElement("button");h.textContent="true"===e.dataset.pinned?"Unpin":"Pin",e.dataset.originalIndex||(e.dataset.originalIndex=Array.from(messagesList.children).indexOf(e),-1!==e.dataset.originalIndex||(e.dataset.originalIndex=messagesList.children.length));let b=JSON.parse(localStorage.getItem("pinnedMessages")||"[]");if(b.includes(t.id)&&(e.dataset.pinned="true",e.style.border="2px solid red",h.textContent="Unpin"),h.onclick=()=>{let n="true"===e.dataset.pinned,s=JSON.parse(localStorage.getItem("pinnedMessages")||"[]");if(n){let a=Array.from(messagesList.children).filter(t=>t!==e),r=parseInt(e.dataset.originalIndex||"0",10);r>=a.length?messagesList.appendChild(e):messagesList.insertBefore(e,a[r]),e.style.border="",e.dataset.pinned="false",h.textContent="Pin",s=s.filter(e=>e!==t.id),localStorage.setItem("pinnedMessages",JSON.stringify(s)),log(`‚ùå Unpinned message id=${t.id}`,null,"info","admin")}else messagesList.insertBefore(e,messagesList.firstChild),e.style.border="2px solid red",e.dataset.pinned="true",h.textContent="Unpin",s.includes(t.id)||s.push(t.id),localStorage.setItem("pinnedMessages",JSON.stringify(s)),log(`üìå Pinned message id=${t.id}`,null,"info","admin")},n.appendChild(h),"Manager"===s){if(t.username===username){let I=document.createElement("button");I.textContent="Delete My Message",I.onclick=async()=>{try{await supabase.from("messages").delete().eq("id",t.id),e.remove(),log(`üóë Deleted own message id=${t.id}`,null,"warn","manager")}catch(n){log("‚ùå Failed to delete own message",n,"error","manager")}},n.appendChild(I)}let C=document.createElement("button");C.textContent="Report Message",C.onclick=async()=>{try{let e={to:"frenchwizz@proton.me",subject:`üö® Message Reported by Manager: ${username}`,text:`Reporter (manager): ${username}
Reported user: ${t.username}
Message ID: ${t.id}
IP: ${t.ip||"unknown"}

Message content:
${t.content||""}`},n=await supabase.functions.invoke("sendEmail",{body:e});if(n.error){let s=n.error.message||JSON.stringify(n.error);log("‚ùå sendEmail function error",n.error,"error","manager"),alert("Failed to report message:\n"+s)}else alert("Message reported successfully!")}catch(a){log("‚ùå Failed to report message",a,"error","manager")}},n.appendChild(C)}e.addEventListener("click",e=>{e.stopPropagation(),n.style.display="none"===n.style.display?"flex":"none"}),document.addEventListener("click",()=>{n.style.display="none"})}document.addEventListener("DOMContentLoaded",async()=>{saveNameBtn&&(saveNameBtn.onclick=saveName),button&&button.addEventListener("click",sendMessage),input&&input.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())});let e=localStorage.getItem("chatUsername");e?(nameInput.value=e,await saveName()):(namePrompt.style.display="block",input.disabled=!0,button.disabled=!0)}),verifyRealtimeConnection(),document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&e.altKey&&"t"===e.key.toLowerCase()&&(e.preventDefault(),localStorage.removeItem("chatUsername"),localStorage.removeItem("chatRole"),location.reload())}),fetch("https://api.ipify.org?format=json").then(e=>e.json()).then(e=>{log("‚úÖ IP: "+(userIp=e.ip),null,"info","network")}).catch(()=>{userIp="unknown",log("‚ùå Failed to get IP",null,"warn","network")});
</script>

</body>
</html>
