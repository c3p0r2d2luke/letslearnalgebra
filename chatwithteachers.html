<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script>
/* ----------------------------------------------------------------------
   Chat App Core Setup
---------------------------------------------------------------------- */
const input = document.getElementById("messageInput");
const button = document.getElementById("sendButton");
const messagesList = document.getElementById("messages");
const logBox = document.getElementById("logBox");
const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameButton");

const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
const supabaseKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M";

let supabase;
try {
  supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
} catch (err) {
  console.warn("âš ï¸ Supabase not available, running in offline mode.");
}

/* ----------------------------------------------------------------------
   Username prompt setup (robust version)
---------------------------------------------------------------------- */
let username = localStorage.getItem("chatUsername") || "";
let currentRole = localStorage.getItem("chatRole") || "User";

async function saveName() {
  const name = nameInput.value.trim();
  if (!name) {
    alert("Please enter a name!");
    return;
  }

  // Save locally
  localStorage.setItem("chatUsername", name);
  username = name;

  // Try to fetch role from DB
  try {
    if (supabase) {
      const { data, error } = await supabase
        .from("users")
        .select("role")
        .eq("username", name)
        .single();

      if (error && error.code !== "PGRST116") {
        console.error("Role lookup failed:", error);
      }

      currentRole = data?.role || "User";
      localStorage.setItem("chatRole", currentRole);
      console.log(`âœ… Saved username '${name}' with role '${currentRole}'`);
    } else {
      console.warn("Offline mode: using local role only.");
    }
  } catch (e) {
    console.warn("Role fetch skipped (offline or error):", e);
  }

  // Hide prompt, enable chat
  namePrompt.style.display = "none";
  input.disabled = false;
  button.disabled = false;
}

// On load, check name
document.addEventListener("DOMContentLoaded", () => {
  if (saveNameBtn) {
    saveNameBtn.onclick = saveName;
  } else {
    console.error("Save Name button not found!");
  }

  const saved = localStorage.getItem("chatUsername");
  if (!saved || saved.trim() === "") {
    namePrompt.style.display = "block";
    input.disabled = true;
    button.disabled = true;
  } else {
    nameInput.value = saved;
    username = saved;
    currentRole = localStorage.getItem("chatRole") || "User";
    namePrompt.style.display = "none";
    input.disabled = false;
    button.disabled = false;
  }
});
/* ----------------------------------------------------------------------
   Logging helper
---------------------------------------------------------------------- */
function log(msg, obj = null, type = "info", src = "sys") {
  const el = document.createElement("div");
  el.textContent = `[${new Date().toLocaleTimeString()}] [${src}] ${msg}`;
  el.className = `log-${type}`;
  logBox?.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
  if (obj) console[type === "error" ? "error" : "log"](msg, obj);
}

/* ----------------------------------------------------------------------
   Offline + online message handling
---------------------------------------------------------------------- */
function getLocalMessages() {
  return JSON.parse(localStorage.getItem("localMessages") || "[]");
}

function saveLocalMessages(messages) {
  localStorage.setItem("localMessages", JSON.stringify(messages));
}

/* ----------------------------------------------------------------------
   Send Message (works offline, syncs later)
---------------------------------------------------------------------- */
async function sendMessage() {
  const content = input.value.trim();
  if (!content || !username) return;

  const newMsg = {
    id: Date.now(),
    username,
    content,
    inserted_at: new Date().toISOString(),
    role: currentRole,
    ip: userIp || "unknown",
    is_pinned: false,
    pending: true // mark unsynced
  };

  // Save immediately to localStorage for offline view
  const localMsgs = getLocalMessages();
  localMsgs.push(newMsg);
  saveLocalMessages(localMsgs);

  // Render instantly
  renderMessages();

  input.value = "";

  // Try syncing online
  try {
    if (supabase) {
      const { error } = await supabase.from("messages").insert([
        {
          username: newMsg.username,
          content: newMsg.content,
          ip: newMsg.ip,
          role: newMsg.role,
          is_pinned: false
        }
      ]);
      if (!error) {
        log("âœ… Message sent to Supabase", null, "info", "network");
        newMsg.pending = false;
        saveLocalMessages(localMsgs);
      } else {
        log("âš ï¸ Message saved offline (Supabase error)", error, "warn", "network");
      }
    } else {
      log("ðŸ’¾ Offline mode â€” message queued for sync", null, "warn", "network");
    }
  } catch (e) {
    log("âš ï¸ Could not send to Supabase (network)", e, "warn", "network");
  }
}

/* ----------------------------------------------------------------------
   Event handler for Send button
---------------------------------------------------------------------- */
button.addEventListener("click", sendMessage);
input.addEventListener("keypress", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

/* ----------------------------------------------------------------------
   Automatic sync when online
---------------------------------------------------------------------- */
async function syncPendingMessages() {
  if (!supabase) return;
  const localMsgs = getLocalMessages();
  const unsent = localMsgs.filter(m => m.pending);

  if (unsent.length === 0) return;

  for (const msg of unsent) {
    try {
      const { error } = await supabase.from("messages").insert([
        {
          username: msg.username,
          content: msg.content,
          ip: msg.ip,
          role: msg.role,
          is_pinned: msg.is_pinned
        }
      ]);
      if (!error) msg.pending = false;
    } catch (e) {
      log("âŒ Failed syncing a message", e, "error", "sync");
    }
  }
  saveLocalMessages(localMsgs);
  log(`ðŸ” Synced ${unsent.length} pending messages`, null, "info", "sync");
}

window.addEventListener("online", syncPendingMessages);
/* ----------------------------------------------------------------------
   Load messages (local first, Supabase second)
---------------------------------------------------------------------- */
async function loadMessages() {
  let localMsgs = getLocalMessages();

  // Sort local messages by timestamp
  localMsgs.sort((a, b) => new Date(a.inserted_at) - new Date(b.inserted_at));

  // Show local first
  renderMessages(localMsgs);

  // Try online fetch
  if (supabase) {
    try {
      const { data, error } = await supabase
        .from("messages")
        .select("*")
        .order("inserted_at", { ascending: true });

      if (!error && data) {
        // Merge new online messages with local ones
        const all = [...localMsgs];
        for (const msg of data) {
          if (!all.some(m => m.id === msg.id)) all.push(msg);
        }
        saveLocalMessages(all);
        renderMessages(all);
        log("âœ… Loaded messages from Supabase", null, "info", "network");
      } else {
        log("âš ï¸ Supabase load error", error, "warn", "network");
      }
    } catch (e) {
      log("âŒ Failed to load from Supabase", e, "error", "network");
    }
  }
}

/* ----------------------------------------------------------------------
   Render messages
---------------------------------------------------------------------- */
function renderMessages(list) {
  if (!list) list = getLocalMessages();
  messagesList.innerHTML = "";

  // Sort pinned first, then by time
  list.sort((a, b) => {
    if (a.is_pinned && !b.is_pinned) return -1;
    if (!a.is_pinned && b.is_pinned) return 1;
    return new Date(a.inserted_at) - new Date(b.inserted_at);
  });

  const pinnedMessages = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");

  for (const msg of list) {
    const li = document.createElement("li");
    li.textContent = `${msg.username}: ${msg.content}`;
    li.dataset.id = msg.id;
    li.dataset.pinned = msg.is_pinned || pinnedMessages.includes(msg.id) ? "true" : "false";

    if (li.dataset.pinned === "true") {
      li.style.border = "2px solid red";
    }

    // --- Create admin/manager controls ---
    const adminDiv = document.createElement("div");
    adminDiv.className = "adminControls";
    adminDiv.style.display = "none";

    // Pin button
    const pinBtn = document.createElement("button");
    pinBtn.textContent = li.dataset.pinned === "true" ? "Unpin" : "Pin";

    pinBtn.onclick = async () => {
      const newPinnedState = li.dataset.pinned !== "true";
      li.dataset.pinned = newPinnedState.toString();
      li.style.border = newPinnedState ? "2px solid red" : "";
      pinBtn.textContent = newPinnedState ? "Unpin" : "Pin";

      // Update local storage
      let pinned = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");
      if (newPinnedState) {
        if (!pinned.includes(msg.id)) pinned.push(msg.id);
      } else {
        pinned = pinned.filter(id => id !== msg.id);
      }
      localStorage.setItem("pinnedMessages", JSON.stringify(pinned));

      // Try updating Supabase
      try {
        if (supabase) {
          const { error } = await supabase
            .from("messages")
            .update({ is_pinned: newPinnedState })
            .eq("id", msg.id);
          if (error) log("âš ï¸ Supabase pin update failed", error, "warn", "network");
        }
      } catch (e) {
        log("âš ï¸ Offline, pin saved locally", e, "warn", "network");
      }

      // Re-render
      renderMessages();
    };

    adminDiv.appendChild(pinBtn);

    // --- Click to toggle admin controls ---
    li.addEventListener("click", e => {
      e.stopPropagation();
      adminDiv.style.display = adminDiv.style.display === "none" ? "flex" : "none";
    });

    document.addEventListener("click", () => {
      adminDiv.style.display = "none";
    });

    li.appendChild(adminDiv);
    messagesList.appendChild(li);
  }
}

/* ----------------------------------------------------------------------
   Load messages when app starts
---------------------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", loadMessages);
// --- Local Storage Sync ---
// Store unsent messages while offline
function saveOfflineMessage(username, content) {
  const unsent = JSON.parse(localStorage.getItem("unsentMessages") || "[]");
  unsent.push({ username, content, time: Date.now() });
  localStorage.setItem("unsentMessages", JSON.stringify(unsent));
}

// Try to send unsent messages when back online
async function sendUnsentMessages() {
  const unsent = JSON.parse(localStorage.getItem("unsentMessages") || "[]");
  if (unsent.length === 0) return;

  for (const msg of unsent) {
    try {
      const { error } = await supabase.from("messages").insert({
        username: msg.username,
        content: msg.content,
      });
      if (!error) {
        console.log("âœ… Sent offline message:", msg.content);
      }
    } catch (e) {
      console.error("âš ï¸ Failed to send:", e);
      return; // stop trying if still offline
    }
  }
  localStorage.removeItem("unsentMessages");
}

// Listen for coming back online
window.addEventListener("online", () => {
  console.log("ðŸŒ Back online! Sending queued messages...");
  sendUnsentMessages();
});

// --- Modified Send Handler ---
button.addEventListener("click", async () => {
  const content = input.value.trim();
  if (!content) return;

  const msg = { username: currentUser, content };

  // Try to send immediately
  try {
    const { error } = await supabase.from("messages").insert(msg);
    if (error) throw error;
    addMessageToUI(currentUser, content);
  } catch {
    // If offline or failed, save locally
    console.warn("Offline, saving message locally:", content);
    saveOfflineMessage(currentUser, content);
    addMessageToUI(currentUser + " (saved offline)", content);
  }

  input.value = "";
});

</script>

</body>
</html>
