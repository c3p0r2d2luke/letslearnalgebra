<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:block; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script>
  /* ----------------------------------------------------------------------
   Chat App Core Setup
---------------------------------------------------------------------- */
const input = document.getElementById("messageInput");
const button = document.getElementById("sendButton");
const messagesList = document.getElementById("messages");
const logBox = document.getElementById("logBox");
const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameButton");

const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
const supabaseKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M"; // <-- replace with your key

let supabase;
try {
  supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // --- Connection Test ---
  async function testSupabaseConnection() {
    try {
      const { data, error } = await supabase.from("messages").select("id").limit(1);
      if (error) {
        log("âš ï¸ Supabase query failed â€” not connected to DB");
      } else {
        log("âœ… Supabase connection OK â€” messages table accessible");
      }
    } catch (e) {
      log("âŒ Supabase connection error (check network or key)");
      console.error(e);
    }
  }
  testSupabaseConnection();

  // --- Live Subscription Status Test ---
  const channel = supabase
    .channel("public:messages")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "messages" },
      (payload) => {
        log(`ðŸ“¡ Live update received (${payload.eventType})`);
        loadMessages(); // reload messages when live update happens
      }
    )
    .subscribe((status) => {
      if (status === "SUBSCRIBED") {
        log("âœ… Subscribed to Supabase live updates");
      } else if (status === "CLOSED") {
        log("âŒ Supabase subscription closed");
      } else if (status === "CHANNEL_ERROR") {
        log("âš ï¸ Supabase live channel error");
      } else {
        log(`â„¹ï¸ Supabase channel status: ${status}`);
      }
    });

} catch (err) {
  console.warn("âš ï¸ Supabase not available, offline mode only.");
  log("âš ï¸ Running in offline mode â€” Supabase connection failed");
}


/* ----------------------------------------------------------------------
   Username prompt & role setup
---------------------------------------------------------------------- */
let username = localStorage.getItem("chatUsername") || "";
let currentRole = localStorage.getItem("chatRole") || "User";

async function saveName() {
  const name = nameInput.value.trim();
  if (!name) return alert("Please enter a name!");

  username = name;
  localStorage.setItem("chatUsername", name);

  if (supabase) {
    try {
      const { data, error } = await supabase
        .from("users")
        .select("role")
        .eq("username", name)
        .single();
      if (!error && data) currentRole = data.role || "User";
    } catch {}
  }

  localStorage.setItem("chatRole", currentRole);

  namePrompt.style.display = "none";
  input.disabled = false;
  button.disabled = false;

  loadMessages();
}

saveNameBtn.onclick = saveName;

// Load saved username
if (username) {
  nameInput.value = username;
  currentRole = localStorage.getItem("chatRole") || "User";
  namePrompt.style.display = "none";
  input.disabled = false;
  button.disabled = false;
  loadMessages();
}

/* ----------------------------------------------------------------------
   Logging helper
---------------------------------------------------------------------- */
function log(msg, obj = null, type = "info") {
  const el = document.createElement("div");
  el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logBox?.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
  if (obj) console[type === "error" ? "error" : "log"](msg, obj);
}

/* ----------------------------------------------------------------------
   LocalStorage helpers
---------------------------------------------------------------------- */
function getLocalMessages() {
  return JSON.parse(localStorage.getItem("localMessages") || "[]");
}

function saveLocalMessages(messages) {
  localStorage.setItem("localMessages", JSON.stringify(messages));
}
/* ----------------------------------------------------------------------
   Send Message (offline first, sync later)
---------------------------------------------------------------------- */
async function sendMessage() {
  const content = input.value.trim();
  if (!content || !username) return;

  const newMsg = {
    id: Date.now(), // temporary ID until Supabase returns real one
    username,
    content,
    inserted_at: new Date().toISOString(),
    role: currentRole,
    ip: "unknown",
    is_pinned: false,
    pending: true
  };

  // Save locally first
  const localMsgs = getLocalMessages();
  localMsgs.push(newMsg);
  saveLocalMessages(localMsgs);

  // Render immediately
  renderMessages(localMsgs);
  input.value = "";

  // Try to send online
  if (supabase) {
    try {
      const { data: insertedData, error } = await supabase
        .from("messages")
        .insert([{
          username: newMsg.username,
          content: newMsg.content,
          role: newMsg.role,
          is_pinned: false
        }])
        .select(); // get DB-assigned ID

      if (!error && insertedData.length > 0) {
        // Replace temporary message with DB message in localStorage
        const updatedLocalMsgs = getLocalMessages().map(m =>
          m.id === newMsg.id ? insertedData[0] : m
        );
        saveLocalMessages(updatedLocalMsgs);
        renderMessages(updatedLocalMsgs);

        log("âœ… Message sent to Supabase");
      }
    } catch (e) {
      log("âš ï¸ Message saved offline", e, "warn");
    }
  }
}



/* ----------------------------------------------------------------------
   Send button & Enter key
---------------------------------------------------------------------- */
button.addEventListener("click", sendMessage);
input.addEventListener("keypress", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

/* ----------------------------------------------------------------------
   Sync offline messages when back online
---------------------------------------------------------------------- */
async function syncPendingMessages() {
  if (!supabase) return;
  const localMsgs = getLocalMessages();
  const unsent = localMsgs.filter(m => m.pending);
  if (unsent.length === 0) return;

  for (const msg of unsent) {
    try {
      const { error } = await supabase.from("messages").insert([{
        username: msg.username,
        content: msg.content,
        role: msg.role,
        is_pinned: msg.is_pinned
      }]);
      if (!error) msg.pending = false;
    } catch (e) {
      log("âŒ Failed syncing a message", e, "error");
    }
  }
  saveLocalMessages(localMsgs);
  log(`ðŸ” Synced ${unsent.length} pending messages`);
}

window.addEventListener("online", syncPendingMessages);

/* ----------------------------------------------------------------------
   Load messages (local first, then online)
---------------------------------------------------------------------- */
async function loadMessages() {
  let localMsgs = getLocalMessages();
  localMsgs.sort((a,b) => new Date(a.inserted_at) - new Date(b.inserted_at));
  renderMessages(localMsgs);

  if (supabase) {
    try {
      const { data, error } = await supabase.from("messages")
        .select("*")
        .order("inserted_at", { ascending: true });
      if (!error && data) {
        const all = [...localMsgs];
        for (const msg of data) {
          if (!all.some(m => m.id === msg.id)) all.push(msg);
        }
        saveLocalMessages(all);
        renderMessages(all);
        log("âœ… Loaded messages from Supabase");
      }
    } catch (e) {
      log("âŒ Failed to load Supabase messages", e, "error");
    }
  }
}
/* ----------------------------------------------------------------------
   Render Messages
---------------------------------------------------------------------- */
function renderMessages(list) {
  const viewerRole = currentRole; // make sure this is defined
  messagesList.innerHTML = "";

  for (const msg of list) {
    const li = document.createElement("li");

    // Add role classes
    if (msg.role === "Admin") li.classList.add("admin");
    else if (msg.role === "Manager") li.classList.add("manager");

    // Username
    const usernameDiv = document.createElement("div");
    usernameDiv.className = "username";
    usernameDiv.textContent = msg.username === "Frenchwizz" ? "Takeo" : msg.username;
    li.appendChild(usernameDiv);

    // Message content
    const contentDiv = document.createElement("div");
    contentDiv.className = "content";
    if (msg.role === "Admin") contentDiv.innerHTML = msg.content || "";
    else contentDiv.textContent = msg.content || "";
    li.appendChild(contentDiv);

    // --- Admin / Manager Panel ---
    const adminDiv = document.createElement("div");
    adminDiv.className = "adminControls";
    adminDiv.style.display = "none";

    // --- Admin Controls (Admins only) ---
    if (viewerRole === "Admin") {
      const delBtn = document.createElement("button");
delBtn.textContent = "Delete";
delBtn.onclick = async () => {
  if (li.dataset.pinned === "true") {
    alert("Cannot delete a pinned message!");
    return;
  }

  try {
    if (supabase) {
      const { error } = await supabase.from("messages").delete().eq("id", msg.id);
      if (error) {
        log("âŒ Failed to delete message", error, "error");
      } else {
        li.remove();

        // Remove from local storage too
        const localMsgs = getLocalMessages().filter(m => m.id !== msg.id);
        saveLocalMessages(localMsgs);

        log(`ðŸ—‘ Deleted message id=${msg.id}`, null, "warn");
      }
    }
  } catch (e) {
    log("âŒ Exception deleting message", e, "error");
  }
};
adminDiv.appendChild(delBtn);


      // Edit
      editBtn.onclick = async () => {
  const newText = prompt("Edit message:", msg.content || "");
  if (newText === null) return;

  try {
    const { error } = await supabase
      .from("messages")
      .update({ content: newText })
      .eq("id", msg.id);

    if (error) {
      log("âŒ Failed editing message", error, "error", "admin");
    } else {
      log(`âœï¸ Edited message id=${msg.id}`, { newText }, "info", "admin");
      // Don't manually update the DOM here
      // Let the live update subscription re-render the message
    }
  } catch (e) {
    log("âŒ Exception editing message", e, "error", "admin");
  }
};
 


      // Change Name
      const nameBtn = document.createElement("button");
      nameBtn.textContent = "Change Name";
      nameBtn.onclick = async () => {
        const newName = prompt("New username for " + msg.username + ":", msg.username);
        if (!newName) return;
        try {
          await supabase.from("users").upsert({ username: newName, blocked: false });
          await supabase.from("messages").update({ username: newName }).eq("username", msg.username);
          document.querySelectorAll("#messages li").forEach(liItem => {
            const el = liItem.querySelector(".username");
            if (el && el.textContent === msg.username) el.textContent = newName;
          });
          log(`ðŸ” Changed username ${msg.username} â†’ ${newName}`, null, "info", "admin");
        } catch (e) {
          log("âŒ Failed to change name", e, "error", "admin");
        }
      };
      adminDiv.appendChild(nameBtn);

      // Toggle Block
      const blockBtn = document.createElement("button");
      blockBtn.textContent = "Toggle Block";
      blockBtn.onclick = async () => {
        if (!msg.ip || msg.ip === "unknown") {
          alert("Cannot block: user IP unknown.");
          return;
        }
        try {
          const { data: existing } = await supabase
            .from("blocked_ips")
            .select("*")
            .eq("ip", msg.ip)
            .maybeSingle();
          if (existing) {
            await supabase.from("blocked_ips").delete().eq("ip", msg.ip);
            alert(`${msg.username}'s IP (${msg.ip}) is now unblocked`);
            log(`ðŸ”“ Unblocked IP ${msg.ip} for ${msg.username}`, null, "warn", "admin");
          } else {
            await supabase.from("blocked_ips").insert({ ip: msg.ip, username: msg.username });
            alert(`${msg.username}'s IP (${msg.ip}) is now blocked`);
            log(`ðŸ”’ Blocked IP ${msg.ip} for ${msg.username}`, null, "warn", "admin");
          }
        } catch (e) {
          log("âŒ Failed toggling IP block", e, "error", "admin");
        }
      };
      adminDiv.appendChild(blockBtn);

      // Force Logout
      const logoutBtn = document.createElement("button");
      logoutBtn.textContent = "Force Logout";
      logoutBtn.onclick = async () => {
        if (msg.username === username) {
          alert("You cannot force logout yourself.");
          return;
        }
        try {
          await supabase.from("users").update({ forceLogout: true }).eq("username", msg.username);
          alert(`${msg.username} has been forced to log out.`);
          log(`ðŸ”Œ Forced logout for ${msg.username}`, null, "warn", "admin");
        } catch (e) {
          log("âŒ Failed to force logout", e, "error", "admin");
        }
      };
      adminDiv.appendChild(logoutBtn);

      // Mute
      const muteBtn = document.createElement("button");
      muteBtn.textContent = "Mute 5min";
      muteBtn.onclick = () => {
        const mutedUsers = (window.__mutedUsers = window.__mutedUsers || {});
        mutedUsers[msg.username] = Date.now() + 5 * 60 * 1000;
        alert(`${msg.username} muted for 5 minutes`);
        log(`ðŸ”‡ Muted ${msg.username} for 5 minutes`, null, "info", "admin");
      };
      adminDiv.appendChild(muteBtn);

      // Export Chat
      const exportBtn = document.createElement("button");
      exportBtn.textContent = "Export Chat";
      exportBtn.onclick = () => {
        const data = Array.from(messagesList.querySelectorAll("li")).map(liItem => ({
          username: liItem.querySelector(".username")?.textContent || "",
          content: liItem.querySelector(".content")?.textContent || "",
          timestamp: liItem.querySelector(".timestamp")?.textContent || ""
        }));
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "chat.json";
        a.click();
        log("ðŸ“¦ Exported chat to chat.json", null, "info", "admin");
      };
      adminDiv.appendChild(exportBtn);

      // Mass Delete by Keyword
      const massDelBtn = document.createElement("button");
      massDelBtn.textContent = "Delete by Keyword";
      massDelBtn.onclick = async () => {
        const keyword = prompt("Enter keyword to delete:");
        if (!keyword) return;
        try {
          const pinned = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");
          const { data } = await supabase.from("messages").select("*");
          const idsToDelete = (data || [])
            .filter(m => String(m.content || "").includes(keyword) && !pinned.includes(m.id))
            .map(m => m.id);
          if (idsToDelete.length) await supabase.from("messages").delete().in("id", idsToDelete);
          Array.from(messagesList.querySelectorAll("li")).forEach(liItem => {
            if ((liItem.querySelector(".content")?.textContent || "").includes(keyword) &&
                liItem.dataset.pinned !== "true")
              liItem.remove();
          });
          log(`ðŸ§¹ Deleted messages containing "${keyword}" (skipped pinned)`, null, "warn", "admin");
        } catch (e) {
          log("âŒ Mass delete failed", e, "error", "admin");
        }
      };
      adminDiv.appendChild(massDelBtn);

      // Delete User & Messages (NUKE)
      const nukeBtn = document.createElement("button");
      nukeBtn.textContent = "Delete User & Messages";
      nukeBtn.onclick = async () => {
        if (!confirm(`Are you sure you want to delete ${msg.username} and ALL their messages? This cannot be undone.`)) return;
        try {
          await supabase.from("messages").delete().eq("username", msg.username);
          const delUser = await supabase.from("users").delete().eq("username", msg.username);
          if (delUser.error) log("âš ï¸ Could not delete user row", delUser.error, "warn", "admin");
          document.querySelectorAll("#messages li").forEach(liItem => {
            if (liItem.querySelector(".username")?.textContent === msg.username) liItem.remove();
          });
          alert(`${msg.username} and all their messages have been deleted.`);
          log(`ðŸ—‘ Deleted all messages by ${msg.username}`, null, "warn", "admin");
        } catch (err) {
          log("âŒ Failed to delete user and messages", err, "error", "admin");
          alert("Error deleting user and messages. See log.");
        }
      };
      adminDiv.appendChild(nukeBtn);

      // User Info
      const infoBtn = document.createElement("button");
      infoBtn.textContent = "User Info";
      infoBtn.onclick = () => {
        alert(
          `Username: ${msg.username}\nIP: ${msg.ip}\nMessage ID: ${msg.id}\nRole: ${msg.role || "User"}`
        );
        log(`â„¹ï¸ Shown info for ${msg.username}`, null, "debug", "admin");
      };
      adminDiv.appendChild(infoBtn);

      // Promote / Demote
      const promoteBtn = document.createElement("button");
      promoteBtn.textContent = "Promote â†’ Manager";
      promoteBtn.onclick = async () => {
        try {
          await supabase.from("users").upsert({ username: msg.username, role: "Manager" });
          log(`ðŸ‘‘ Promoted ${msg.username} to Manager`, null, "info", "admin");
          await loadMessages();
        } catch (e) {
          log("âŒ Promote failed", e, "error", "admin");
        }
      };
      adminDiv.appendChild(promoteBtn);

      const promoteAdminBtn = document.createElement("button");
      promoteAdminBtn.textContent = "Promote â†’ Admin";
      promoteAdminBtn.onclick = async () => {
        try {
          await supabase.from("users").upsert({ username: msg.username, role: "Admin" });
          log(`ðŸ‘‘ Promoted ${msg.username} to Admin`, null, "info", "admin");
          await loadMessages();
        } catch (e) {
          log("âŒ Promote to Admin failed", e, "error", "admin");
        }
      };
      adminDiv.appendChild(promoteAdminBtn);

      const demoteBtn = document.createElement("button");
      demoteBtn.textContent = "Demote â†’ User";
      demoteBtn.onclick = async () => {
        try {
          await supabase.from("users").upsert({ username: msg.username, role: "User" });
          log(`ðŸ”» Demoted ${msg.username} to User`, null, "info", "admin");
          await loadMessages();
        } catch (e) {
          log("âŒ Demote failed", e, "error", "admin");
        }
      };
      adminDiv.appendChild(demoteBtn);
    }

    // --- Manager Controls (Managers only) ---
    if (viewerRole === "Manager") {
      if (msg.username === username) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete My Message";
        delBtn.onclick = async () => {
          try {
            await supabase.from("messages").delete().eq("id", msg.id);
            li.remove();
            log(`ðŸ—‘ Deleted own message id=${msg.id}`, null, "warn", "manager");
          } catch (e) {
            log("âŒ Failed to delete own message", e, "error", "manager");
          }
        };
        adminDiv.appendChild(delBtn);
      }

      const reportBtn = document.createElement("button");
      reportBtn.textContent = "Report Message";
      reportBtn.onclick = async () => {
        try {
          const payload = {
            to: "frenchwizz@proton.me",
            subject: `ðŸš¨ Message Reported by Manager: ${username}`,
            text: `Reporter (manager): ${username}\nReported user: ${msg.username}\nMessage ID: ${msg.id}\nIP: ${msg.ip || "unknown"}\n\nMessage content:\n${msg.content || ""}`
          };
          const res = await supabase.functions.invoke("sendEmail", { body: payload });
          if (res.error) {
            const errMsg = res.error.message || JSON.stringify(res.error);
            log("âŒ sendEmail function error", res.error, "error", "manager");
            alert("Failed to report message:\n" + errMsg);
          } else alert("Message reported successfully!");
        } catch (e) {
          log("âŒ Failed to report message", e, "error", "manager");
        }
      };
      adminDiv.appendChild(reportBtn);
    }

    // --- User Controls (Users) ---
    if (viewerRole === "User") {
      adminDiv.style.display = "none"; // Users never see the panel
    }

// --- PIN / UNPIN (Admins only) ---
if (viewerRole === "Admin") {
  // --- PIN / UNPIN (Admins & Managers) ---
if (viewerRole === "Admin" || viewerRole === "Manager") {
  const pinBtn = document.createElement("button");
  pinBtn.textContent = msg.is_pinned ? "Unpin" : "Pin";

  if (msg.is_pinned) {
    li.dataset.pinned = "true";
    li.style.border = "2px solid red";
  }

  pinBtn.onclick = async () => {
    const isPinned = li.dataset.pinned === "true";

    try {
      // Update Supabase
      await supabase.from("messages").update({ is_pinned: !isPinned }).eq("id", msg.id);

      // Update local object
      msg.is_pinned = !isPinned;

      // Update UI
      li.dataset.pinned = msg.is_pinned ? "true" : "false";
      li.style.border = msg.is_pinned ? "2px solid red" : "";
      pinBtn.textContent = msg.is_pinned ? "Unpin" : "Pin";

      log(`${msg.is_pinned ? "ðŸ“Œ Pinned" : "âŒ Unpinned"} message id=${msg.id}`, null, "info");

      // Move pinned messages to top
      if (msg.is_pinned) messagesList.insertBefore(li, messagesList.firstChild);
      else loadMessages(); // reload for original order
    } catch (e) {
      log("âŒ Failed to pin/unpin message", e, "error");
    }
  };

  adminDiv.appendChild(pinBtn);
}


}

    // --- Toggle Admin / Manager Panel ---
    if (viewerRole !== "User") {
      li.addEventListener("click", e => {
        e.stopPropagation();
        adminDiv.style.display = adminDiv.style.display === "none" ? "flex" : "none";
      });
      document.addEventListener("click", () => {
        adminDiv.style.display = "none";
      });
    }

    li.appendChild(adminDiv);
    messagesList.appendChild(li);
  }
}

/* ----------------------------------------------------------------------
   Save Name & Setup
---------------------------------------------------------------------- */
async function saveName() {
  const name = nameInput.value.trim();
  if (!name) {
    alert("Please enter a name!");
    return;
  }

  localStorage.setItem("chatUsername", name);
  username = name;

  // Fetch role from Supabase if available
  try {
    if (supabase) {
      const { data, error } = await supabase
        .from("users")
        .select("role")
        .eq("username", name)
        .single();

      if (!error && data) {
        currentRole = data.role || "User";
        localStorage.setItem("chatRole", currentRole);
      } else {
        currentRole = "User";
      }
    } else {
      currentRole = "User"; // offline fallback
    }
  } catch (err) {
    console.warn("Role fetch failed:", err);
    currentRole = "User";
  }

  namePrompt.style.display = "none";
  input.disabled = false;
  button.disabled = false;

  renderMessages(getLocalMessages());
}

// Hook up Save button
saveNameBtn.addEventListener("click", saveName);

// Auto-load username on page load
document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("chatUsername");
  if (saved && saved.trim() !== "") {
    username = saved;
    currentRole = localStorage.getItem("chatRole") || "User";
    namePrompt.style.display = "none";
    input.disabled = false;
    button.disabled = false;
  } else {
    namePrompt.style.display = "block";
    input.disabled = true;
    button.disabled = true;
  }
});

/* ----------------------------------------------------------------------
   Logout Shortcut (Ctrl+Shift+L)
---------------------------------------------------------------------- */
document.addEventListener("keydown", (e) => {
  if ((e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "t") {
    e.preventDefault();
    localStorage.removeItem("chatUsername");
    localStorage.removeItem("chatRole");
    location.reload();
  }
});


/* ----------------------------------------------------------------------
   Initial load
---------------------------------------------------------------------- */
loadMessages();

</script>

</body>
</html>
