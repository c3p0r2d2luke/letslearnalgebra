<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat With Teachers</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: #fff;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #111;
    padding: 10px;
    text-align: center;
    font-size: 20px;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  #input-area {
    display: flex;
    padding: 10px;
    background: #111;
  }
  #input-area input {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    margin-right: 5px;
  }
  #input-area button {
    padding: 10px 15px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  #namePrompt {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  #namePrompt input {
    padding: 10px;
    border: none;
    border-radius: 6px;
    width: 250px;
    margin-bottom: 10px;
    text-align: center;
  }
  #namePrompt button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    background: #28a745;
    color: #fff;
    cursor: pointer;
  }
  #logBox {
    display: none;
    background: #111;
    color: #0f0;
    padding: 10px;
    font-family: monospace;
    height: 150px;
    overflow-y: auto;
    border-top: 2px solid #333;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>ðŸ’¬ Takeo Chat</header>

<div id="messages"></div>

<div id="input-area">
  <input id="messageInput" placeholder="Type a message..." disabled>
  <button id="sendBtn" disabled>Send</button>
</div>

<div id="namePrompt">
  <input id="nameInput" placeholder="Enter your name">
  <button id="saveNameBtn">Save Name</button>
</div>

<div id="logBox"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
const supabaseKey = "sb_publishable_7uXWpCRbMA4Zq-qiWz9Dmw__G1n8GIA";
const supabase = createClient(supabaseUrl, supabaseKey);

const nameInput = document.getElementById("name");
const saveNameBtn = document.getElementById("save-name");
const messageInput = document.getElementById("message");
const sendBtn = document.getElementById("send");
const messagesContainer = document.getElementById("messages");

let currentUsername = localStorage.getItem("username") || "";

// âœ… Load saved name
if (currentUsername) {
  nameInput.value = currentUsername;
  nameInput.disabled = true;
  saveNameBtn.textContent = "Saved âœ…";
  saveNameBtn.disabled = true;
}

// âœ… Save name (local + database)
saveNameBtn.addEventListener("click", async () => {
  const newName = nameInput.value.trim();
  if (!newName) return alert("Please enter a name.");

  currentUsername = newName;
  localStorage.setItem("username", newName);

  nameInput.disabled = true;
  saveNameBtn.textContent = "Saved âœ…";
  saveNameBtn.disabled = true;

  // Save to DB
  const { error } = await supabase
    .from("users")
    .upsert({
      username: newName,
      role: "User",
      forcelogout: false,
      blocked: false
    });

  if (error) console.error("Error saving user:", error);
});

// âœ… Send message
sendBtn.addEventListener("click", async () => {
  const content = messageInput.value.trim();
  if (!content) return alert("Enter a message!");
  if (!currentUsername) return alert("Please save your name first.");

  const { error } = await supabase.from("messages").insert({
    username: currentUsername,
    content: content
  });

  if (error) console.error("Error sending message:", error);
  else messageInput.value = "";
});

// âœ… Add message to chat
function addMessage(msg) {
  const div = document.createElement("div");
  div.classList.add("message");
  div.innerHTML = `<strong>${msg.username}:</strong> ${msg.content}`;
  messagesContainer.appendChild(div);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// âœ… Load messages
async function loadMessages() {
  const { data, error } = await supabase
    .from("messages")
    .select("*")
    .order("inserted_at", { ascending: true });

  if (error) return console.error("Error loading messages:", error);
  messagesContainer.innerHTML = "";
  data.forEach(addMessage);
}
loadMessages();

// âœ… Realtime updates
supabase
  .channel("messages-channel")
  .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, (payload) => {
    addMessage(payload.new);
  })
  .subscribe();

// âœ… Sign-out combo (Ctrl + Alt + Shift + T)
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.altKey && e.shiftKey && e.key.toLowerCase() === "t") {
    localStorage.removeItem("username");
    window.location.reload();
  }
});
</script>



</body>
</html>
