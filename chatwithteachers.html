<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
#signOutButton { margin-left:8px; background:#f04747; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
    <button id="signOutButton" style="display:none;">Sign Out</button>
</div>

<ul id="messages"></ul>
<div id="logBox"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
    const supabaseKey = "sb_publishable_7uXWpCRbMA4Zq-qiWz9Dmw__G1n8GIA";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let username = localStorage.getItem("chatUsername") || "";
    let currentRole = localStorage.getItem("chatRole") || "User";
    let isAdmin = false;
    let userIp = "";

    const input = document.getElementById("messageInput");
    const button = document.getElementById("sendButton");
    const messagesList = document.getElementById("messages");
    const logBox = document.getElementById("logBox");
    const namePrompt = document.getElementById("namePrompt");
    const nameInput = document.getElementById("nameInput");
    const saveNameBtn = document.getElementById("saveNameButton");
    const signOutBtn = document.getElementById("signOutButton");

    function log(msg, obj = null, level = "info", context = null) {
        const now = new Date();
        const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}.${now.getMilliseconds()}`;
        const colors = { info: "#0f0", warn: "#ff0", error: "#f00", debug: "#0ff" };
        const color = colors[level] || "#0f0";
        console.log(`[${timestamp}] ${level.toUpperCase()}${context ? " ("+context+")" : ""}: ${msg}`, obj);
        if(!isAdmin) return;
        const entry = document.createElement("div");
        entry.style.marginBottom = "6px";
        entry.style.borderBottom = "1px solid #333";
        entry.style.paddingBottom = "4px";
        entry.innerHTML = `
            <div>
                <strong style="color:${color}">[${timestamp}] ${level.toUpperCase()}</strong>
                ${context ? `<em style="color:#aaa">(${context})</em>` : ""}
            </div>
            <div style="margin-left:8px">${msg}</div>
        `;
        if(obj){
            const pre = document.createElement("pre");
            pre.textContent = JSON.stringify(obj, null, 2);
            pre.style.background="#111";
            pre.style.color="#0f0";
            pre.style.padding="4px";
            pre.style.borderRadius="4px";
            pre.style.overflowX="auto";
            pre.style.fontSize="11px";
            pre.style.maxHeight="150px";
            entry.appendChild(pre);
        }
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
    }

    async function fetchOrCreateUserRecord(name){
        if(!name) return {username:name, role:"User"};
        try {
            const { data, error } = await supabase.from("users").select("username,role,blocked,forceLogout").eq("username", name).maybeSingle();
            if(error) log("❌ Error fetching user record", error, "error", "users");
            if(data){
                if(!data.role) data.role="User";
                return { username: data.username, role: data.role, blocked: data.blocked||false, forceLogout:data.forceLogout||false };
            } else {
                const up = await supabase.from("users").upsert({username:name, role:"User", blocked:false, forceLogout:false});
                if(up.error) log("❌ Error upserting default user", up.error, "error", "users");
                return { username:name, role:"User", blocked:false, forceLogout:false };
            }
        } catch(e){
            log("❌ Exception fetching/creating user", e, "error", "users");
            return { username:name, role:"User" };
        }
    }

    async function saveName(){
        const val = nameInput.value.trim();
        if(!val) return alert("Name required!");
        username = val;
        const userRecord = await fetchOrCreateUserRecord(username);
        currentRole = userRecord.role || "User";
        currentRole = currentRole.charAt(0).toUpperCase() + currentRole.slice(1);
        localStorage.setItem("chatUsername", username);
        localStorage.setItem("chatRole", currentRole);

        if(username.toLowerCase() === "frenchwizz" || currentRole==="Admin"){
            isAdmin=true;
            logBox.style.display="block";
            log("Logged in as ADMIN.", null, "info", "auth");
        } else isAdmin=false;

        namePrompt.style.display="none";
        input.disabled=false;
        button.disabled=false;
        signOutBtn.style.display="inline-block";

        await loadMessages();
    }

    saveNameBtn.onclick = saveName;

    signOutBtn.onclick = ()=>{
        localStorage.removeItem("chatUsername");
        localStorage.removeItem("chatRole");
        location.reload();
    };

    async function loadMessages(){
        try{
            const {data, error} = await supabase.from("messages").select("*").order("inserted_at",{ascending:true});
            if(error){ log("❌ Load error: "+error.message, error, "error", "messages"); return; }
            messagesList.innerHTML="";
            data.forEach(msg=>addMessage(msg));
            log(`✅ Loaded ${data.length} messages.`, null, "info", "messages");
        } catch(e){ log("❌ Exception loading messages", e, "error", "messages"); }

        supabase.channel("public:messages")
            .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload=>{ addMessage(payload.new); })
            .on("postgres_changes", { event: "UPDATE", schema: "public", table: "messages" }, payload=>{ addMessage(payload.new); })
            .on("postgres_changes", { event: "DELETE", schema: "public", table: "messages" }, payload=>{
                const node=document.getElementById("msg-"+payload.old.id);
                if(node) node.remove();
            })
            .subscribe((status)=>{ if(status==="SUBSCRIBED") log("✅ Realtime subscription confirmed (messages channel)", null, "info", "messages"); });
    }

    function addMessage(msg){
        if(!msg||!msg.id) return;
        const existing=document.getElementById("msg-"+msg.id);
        if(existing) existing.remove();
        const li=document.createElement("li");
        li.id="msg-"+msg.id;
        const msgRole=(msg.username==="Takeo")?"Admin":(msg.role||"User");
        if(msgRole==="Admin") li.classList.add("admin");
        if(msgRole==="Manager") li.classList.add("manager");
        const displayName=msg.username==="Frenchwizz"?"Takeo":(msg.username||"Unknown");
        li.innerHTML=`<div class="username">${displayName}</div><div class="content">${msg.content}</div><div class="timestamp">${msg.inserted_at?new Date(msg.inserted_at).toLocaleTimeString():"?"}</div><span class="userIp">${msg.ip||"unknown"}</span>`;
        messagesList.appendChild(li);
        messagesList.scrollTop=messagesList.scrollHeight;
    }

    async function sendMessage(){
        const text=input.value.replace(/\r/g,"").trim();
        if(!text) return;
        const clean=text;
        try{
            const { data, error } = await supabase.from("messages").insert({content:clean, username, ip:userIp}).select();
            if(error) log("❌ Message failed to send", null, "error", "messages"); else log("✅ Message sent successfully", null, "info", "messages");
        } catch(e){ log("❌ Exception inserting message", e, "error", "messages"); }
        input.value="";
    }

    input.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ if(e.shiftKey) return; e.preventDefault(); sendMessage(); } });
    button.addEventListener("click", sendMessage);

    // Auto-login if username stored
    if(localStorage.getItem("chatUsername")){
        username=localStorage.getItem("chatUsername");
        currentRole=localStorage.getItem("chatRole")||"User";
        if(username.toLowerCase()==="frenchwizz"||currentRole==="Admin"){ isAdmin=true; logBox.style.display="block"; }
        namePrompt.style.display="none";
        input.disabled=false;
        button.disabled=false;
        signOutBtn.style.display="inline-block";
        loadMessages();
    }

});
</script>
</body>
</html>
