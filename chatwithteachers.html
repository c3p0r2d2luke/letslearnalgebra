<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supabase Chat</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #1a1a1a;
    }
    .message {
      margin-bottom: 8px;
      padding: 6px 10px;
      background: #222;
      border-radius: 8px;
    }
    .message.admin {
      background: #242;
    }
    #controls {
      display: flex;
      padding: 10px;
      background: #000;
    }
    #input {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 4px;
      background: #222;
      color: #fff;
    }
    #button {
      margin-left: 6px;
      padding: 6px 12px;
      background: #444;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #button:hover {
      background: #666;
    }
    #logBox {
      display: none;
      padding: 10px;
      font-size: 12px;
      background: #000;
      color: #0f0;
      max-height: 100px;
      overflow-y: auto;
      border-top: 1px solid #333;
    }
    #namePrompt {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      background: #111;
      color: #ccc;
    }
    #nameInput {
      margin-top: 10px;
      padding: 6px;
      border-radius: 4px;
      border: none;
      background: #222;
      color: #fff;
    }
    #saveName {
      margin-top: 6px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #444;
      color: #fff;
      cursor: pointer;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="namePrompt">
    <h2>Enter your chat name</h2>
    <input id="nameInput" placeholder="Username" />
    <button id="saveName">Continue</button>
  </div>

  <div id="messages" style="display:none"></div>
  <div id="controls" style="display:none">
    <input id="input" placeholder="Type a message..." disabled />
    <button id="button" disabled>Send</button>
  </div>
  <div id="logBox"></div>

  <script>
  // ---- Supabase setup ----
  const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
  const supabaseKey = "sb_publishable_7uXWpCRbMA4Zq-qiWz9Dmw__G1n8GIA";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // ---- DOM elements ----
  const messagesEl = document.getElementById("messages");
  const input = document.getElementById("input");
  const button = document.getElementById("button");
  const namePrompt = document.getElementById("namePrompt");
  const nameInput = document.getElementById("nameInput");
  const saveName = document.getElementById("saveName");
  const logBox = document.getElementById("logBox");
  const controls = document.getElementById("controls");

  // ---- State ----
  let username = null;
  let currentRole = "User";
  let isAdmin = false;
  let userIp = "0.0.0.0";

  // ---- Utility ----
  function log(msg, obj, level = "info", src = "system") {
    console[level === "error" ? "error" : "log"](`[${src}]`, msg, obj || "");
    const div = document.createElement("div");
    div.textContent = `[${src}] ${msg}`;
    logBox.appendChild(div);
    logBox.scrollTop = logBox.scrollHeight;
  }

  function enableUI() {
    namePrompt.style.display = "none";
    messagesEl.style.display = "block";
    controls.style.display = "flex";
    input.disabled = false;
    button.disabled = false;
  }

  // ---- Name handling ----
  saveName.addEventListener("click", async () => {
    const val = nameInput.value.trim();
    if (!val) return alert("Enter a name");
    username = val;
    localStorage.setItem("chatUsername", username);

    const { data, error } = await supabase
      .from("users")
      .upsert({ username })
      .select("role")
      .maybeSingle();
    if (error) log("Error saving user", error, "error", "auth");

    currentRole = data?.role || "User";
    localStorage.setItem("chatRole", currentRole);

    if (username.toLowerCase() === "frenchwizz" || currentRole === "Admin") {
      isAdmin = true;
      logBox.style.display = "block";
      log("Logged in as ADMIN", null, "info", "auth");
    }

    enableUI();
    loadMessages();
  });

  // ---- Send messages ----
  button.addEventListener("click", sendMessage);
  input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage(){
    const text = input.value.replace(/\r/g,"").trim();
    if(!text) return;
    if(mutedUsers[username] && Date.now() < mutedUsers[username]) { alert("You are muted!"); return; }

    // check users table for blocked state (best-effort)
    try {
        const { data: userRow } = await supabase.from("users").select("blocked, forceLogout, role").eq("username", username).maybeSingle();
        if (userRow?.blocked) { alert("You are blocked!"); return; }
        if (userRow?.forceLogout) {
            localStorage.removeItem("chatUsername");
            localStorage.removeItem("chatRole");
            alert("You have been forced to log out.");
            location.reload();
            return;
        }
        if(userRow?.role) currentRole = userRow.role;
    } catch(e) {
        log("âŒ Error checking user row before send", e, "error", "users");
    }

    // image restriction: only Manager and Admin allowed to send content containing <img
    if(!isAdmin) {
        const roleToCheck = (username === "Takeo") ? "Admin" : (currentRole || "User");
        if(roleToCheck === "User" && text.includes("<img")) {
            alert("ðŸš« Only Manager or Admin can paste images.");
            return;
        }
    }

    // NEW: only Admins can send *any* HTML
    const roleToCheck = (username === "Takeo") ? "Admin" : (currentRole || "User");
    if (roleToCheck !== "Admin" && /<[^>]+>/.test(text)) {
        alert("ðŸš« Only admins can send HTML.");
        return;
    }

    // filter bad words (this will trigger email notifications if found)
    const clean = isAdmin ? text : filterMessage(text);

    // insert message WITHOUT role column
    try {
        const { data, error } = await supabase
            .from("messages")
            .insert({ content: clean, username, ip: userIp }) // <-- removed role
            .select();
        if(error) {
            log("âŒ Message failed to send", null, "error", "messages");
        } else {
            log("âœ… Message sent successfully", null, "info", "messages");
        }
    } catch(e) {
        log("âŒ Exception inserting message", e, "error", "messages");
    }

    input.value = "";
}


  // ---- Load messages ----
  async function loadMessages() {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .order("id", { ascending: true });
    if (error) return log("Error loading messages", error, "error", "load");

    messagesEl.innerHTML = "";
    for (const msg of data) renderMessage(msg);
    scrollToBottom(true);
  }

  // ---- Render message ----
  function renderMessage(msg) {
    const div = document.createElement("div");
    div.className = "message";
    if (msg.role === "Admin") div.classList.add("admin");
    div.innerHTML = `<b>${msg.username}:</b> ${msg.content}`;
    messagesEl.appendChild(div);
    scrollToBottom();
  }

  // ---- Realtime ----
  supabase
    .channel("messages")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
      renderMessage(payload.new);
    })
    .subscribe();

  // ---- Scroll handling ----
  function scrollToBottom(force = false) {
    const atBottom =
      messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 50;
    if (force || atBottom) {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  }

  // ---- Auto login ----
  const savedUsername = localStorage.getItem("chatUsername");
  if (savedUsername) {
    username = savedUsername;
    currentRole = localStorage.getItem("chatRole") || "User";

    if (username.toLowerCase() === "frenchwizz" || currentRole === "Admin") {
      isAdmin = true;
      logBox.style.display = "block";
      log("Auto-logged in as ADMIN", null, "info", "auth");
    }

    enableUI();
    loadMessages();
  }
  </script>
</body>
</html>
