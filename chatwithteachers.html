<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Takeo Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: #fff;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #111;
    padding: 10px;
    text-align: center;
    font-size: 20px;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  #input-area {
    display: flex;
    padding: 10px;
    background: #111;
  }
  #input-area input {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    margin-right: 5px;
  }
  #input-area button {
    padding: 10px 15px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  #namePrompt {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  #namePrompt input {
    padding: 10px;
    border: none;
    border-radius: 6px;
    width: 250px;
    margin-bottom: 10px;
    text-align: center;
  }
  #namePrompt button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    background: #28a745;
    color: #fff;
    cursor: pointer;
  }
  #logBox {
    display: none;
    background: #111;
    color: #0f0;
    padding: 10px;
    font-family: monospace;
    height: 150px;
    overflow-y: auto;
    border-top: 2px solid #333;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>üí¨ Takeo Chat</header>

<div id="messages"></div>

<div id="input-area">
  <input id="messageInput" placeholder="Type a message..." disabled>
  <button id="sendBtn" disabled>Send</button>
</div>

<div id="namePrompt">
  <input id="nameInput" placeholder="Enter your name">
  <button id="saveNameBtn">Save Name</button>
</div>

<div id="logBox"></div>

<script>
const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
const supabaseKey = "sb_publishable_7uXWpCRbMA4Zq-qiWz9Dmw__G1n8GIA";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const messagesDiv = document.getElementById("messages");
const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameBtn");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const logBox = document.getElementById("logBox");

let username = localStorage.getItem("chatUsername");
let isAdmin = false;
let currentRole = localStorage.getItem("chatRole") || "User";

function log(msg, data = null, level = "info", category = "sys") {
  const time = new Date().toLocaleTimeString();
  const entry = `[${time}] ${level.toUpperCase()}(${category})\n${msg}${data ? "\n" + JSON.stringify(data, null, 2) : ""}\n\n`;
  logBox.textContent += entry;
  logBox.scrollTop = logBox.scrollHeight;
  console.log(entry);
}

async function fetchOrCreateUserRecord(name) {
  try {
    const { data, error } = await supabase
      .from("users")
      .select("*")
      .eq("username", name)
      .maybeSingle();

    if (error) throw error;

    if (!data) {
      const { error: insertError } = await supabase
        .from("users")
        .insert({ username: name, role: "User" });
      if (insertError) throw insertError;
      log(`‚úÖ Created new user: ${name}`, null, "info", "users");
      return { username: name, role: "User" };
    } else {
      log(`‚úÖ Fetched existing user: ${name}`, data, "info", "users");
      return data;
    }
  } catch (err) {
    log("‚ùå Error fetching or creating user", err, "error", "users");
    return null;
  }
}

// Save name fix
saveNameBtn.onclick = async () => {
  const name = nameInput.value.trim();
  if (!name) return alert("Enter a valid name");
  localStorage.setItem("chatUsername", name);
  username = name;
  namePrompt.style.display = "none";
  input.disabled = false;
  sendBtn.disabled = false;
  const userRecord = await fetchOrCreateUserRecord(name);
  if (userRecord && userRecord.role === "Admin") {
    isAdmin = true;
    logBox.style.display = "block";
    log("Logged in as ADMIN", null, "info", "auth");
  }
  loadMessages();
};

// Send message fix
sendBtn.onclick = async () => {
  const content = input.value.trim();
  if (!content) return;
  input.value = "";

  const { error } = await supabase
    .from("messages")
    .insert([{ username, content }]);

  if (error) {
    log("‚ùå Error sending message", error, "error", "messages");
  }
};

async function loadMessages() {
  const { data, error } = await supabase
    .from("messages")
    .select("*")
    .order("inserted_at", { ascending: true })
    .limit(50);

  if (error) {
    log("‚ùå Error loading messages", error, "error", "messages");
    return;
  }
  messagesDiv.innerHTML = "";
  data.forEach(addMessage);
  subscribeRealtime();
}

function addMessage(msg) {
  const div = document.createElement("div");
  div.innerHTML = `<strong>${msg.username}:</strong> ${msg.content}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function subscribeRealtime() {
  supabase
    .channel("messages")
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "messages" },
      (payload) => addMessage(payload.new)
    )
    .subscribe((status) => log(`Realtime subscription status: ${status}`, null, "debug", "messages"));
}

// Hotkey: Ctrl + Alt + Shift + T = Sign out
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.altKey && e.shiftKey && e.key.toLowerCase() === "t") {
    localStorage.removeItem("chatUsername");
    localStorage.removeItem("chatRole");
    location.reload();
  }
});

// Auto-login persisted username
if (username) {
  nameInput.value = username;
  namePrompt.style.display = "none";
  input.disabled = false;
  sendBtn.disabled = false;

  fetchOrCreateUserRecord(username).then(userRecord => {
    currentRole = userRecord.role || "User";
    localStorage.setItem("chatRole", currentRole);
    if (currentRole === "Admin") {
      isAdmin = true;
      logBox.style.display = "block";
      log("Auto-logged in as ADMIN", null, "info", "auth");
    }
    loadMessages();
  });
}
</script>
</body>
</html>
