<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
#controls { display: none; opacity: 0; transition: opacity 0.4s ease; }
#controls.visible { display: flex; opacity: 1; }
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:block; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#5865f2; font-weight:700; color:#fff; } 
#messages li.manager { background:#2d7d46; font-weight:700; color:#fff; } 
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
#authForm { margin-bottom:16px; display:flex; flex-direction:column; gap:6px; }
#authForm input { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; }
#authForm button { width:fit-content; }
#nameSignup { display:none; flex-direction:column; gap:6px; }
#authMsg { color:#f88; font-size:13px; }
</style>
<link rel="icon" href="favicon.ico" />
</head>
<body>
<h1>Chat Room</h1>

<div id="authForm">
    <input type="email" id="emailInput" placeholder="Email" />
    <input type="password" id="passwordInput" placeholder="Password" />
    <button id="loginButton">Login / Sign Up</button>
    <div id="authMsg"></div>
    <div id="nameSignup">
        <input type="text" id="nameInput" placeholder="Enter your real name" />
        <button id="saveNameButton">Save Name</button>
    </div>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>
<div id="logBox" style="display:none;"></div>

<script>
const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
const supabaseKey = "sb_publishable_1HWGEhoX-b4jj05hDKsGYw_H004LgVz";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

const authForm = document.getElementById("authForm");
const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const loginButton = document.getElementById("loginButton");
const authMsg = document.getElementById("authMsg");
const nameSignup = document.getElementById("nameSignup");
const nameInput = document.getElementById("nameInput");
const saveNameButton = document.getElementById("saveNameButton");

const input = document.getElementById("messageInput");
const button = document.getElementById("sendButton");
const messagesList = document.getElementById("messages");
const logBox = document.getElementById("logBox");

let currentUser = null;
let currentRole = "User";
const messagesMap = new Map();
let channel = null;

// Logging
function log(msg,obj=null,type="info"){
    const el=document.createElement("div");
    el.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
    logBox.appendChild(el);
    logBox.scrollTop=logBox.scrollHeight;
    if(obj) console[type==="error"?"error":"log"](msg,obj);
}

// Post-login setup
async function postLoginSetup(){
    if(!currentUser) return;
    const nameVal=nameInput.value.trim();
    await supabaseClient.from("users").upsert({
        id: currentUser.id,
        username: nameVal || currentUser.email.split("@")[0],
        role:"User"
    },{onConflict:["id"]});
    const { data } = await supabaseClient.from("users")
        .select("role, username")
        .eq("id", currentUser.id)
        .maybeSingle();
    currentRole=data?.role||"User";

    authForm.style.display="none";
    document.getElementById("controls").classList.add("visible");
    input.disabled=false; button.disabled=false;
    logBox.style.display=currentRole==="Admin"?"block":"none";

    loadMessages();
    initRealtime();
}

// Login or show name for signup
async function loginOrSignUp(){
    authMsg.textContent="";
    const email=emailInput.value.trim();
    const password=passwordInput.value.trim();
    if(!email||!password){ authMsg.textContent="Enter email & password"; return; }
    try{
        const { data: signInData, error: signInErr }=await supabaseClient.auth.signInWithPassword({email,password});
        if(signInErr){
            if(signInErr.status===400 || signInErr.status===401){
                currentUser=null;
                nameSignup.style.display="flex";
                return;
            } else { authMsg.textContent="Auth failed: "+signInErr.message; return; }
        } else currentUser=signInData.user;
        await postLoginSetup();
    }catch(e){ console.error(e); authMsg.textContent="Login error"; }
}

// Save name on signup
saveNameButton.addEventListener("click",async()=>{
    const nameVal=nameInput.value.trim();
    if(!nameVal) return;
    try{
        const email=emailInput.value.trim();
        const password=passwordInput.value.trim();
        const { data: signUpData, error: signUpErr }=await supabaseClient.auth.signUp({email,password});
        if(signUpErr){ authMsg.textContent="Sign up failed"; return; }
        currentUser=signUpData.user;
        await postLoginSetup();
    }catch(e){ console.error(e); authMsg.textContent="Failed to save name"; }
});

loginButton.addEventListener("click",loginOrSignUp);

// Send message
async function sendMessage(){
    const content=input.value.trim();
    if(!content || !currentUser) return;
    try{
        let ip="unknown";
        try{
            const res=await fetch("https://api.ipify.org?format=json");
            ip=(await res.json()).ip||"unknown";
        }catch{}
        await supabaseClient.from("messages").insert({
            content,
            user_id:currentUser.id,
            is_pinned:false,
            ip
        }).select();
        input.value="";
        log("âœ… Message sent");
    }catch(e){ log("âŒ Failed to send message",e,"error"); }
}

button.addEventListener("click",sendMessage);
input.addEventListener("keypress",e=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMessage(); }});

// Load messages
async function loadMessages(){
    try{
        const { data,error }=await supabaseClient.from("messages")
            .select(`id, content, is_pinned, inserted_at, user_id, users!inner(username, role)`)
            .order("inserted_at",{ascending:true});
        if(error) return log("âŒ Failed to load messages",error,"error");
        data.forEach(msg=>{
            msg.username=msg.users.username;
            msg.role=msg.users.role;
            renderMessage(msg);
        });
        log("âœ… Messages loaded");
    }catch(e){ log("âŒ Load messages failed",e,"error"); }
}

// Render messages with admin/manager controls intact
function renderMessage(msg){
    let li=messagesMap.get(msg.id);
    if(!li){ li=document.createElement("li"); messagesMap.set(msg.id,li); messagesList.appendChild(li); }

    li.innerHTML=""; li.className="";
    if(msg.role==="Admin") li.classList.add("admin");
    else if(msg.role==="Manager") li.classList.add("manager");
    li.dataset.pinned=msg.is_pinned?"true":"false";
    li.style.border=msg.is_pinned?"2px solid red":"";

    const uname=document.createElement("div");
    uname.className="username";
    uname.textContent=msg.username;
    li.appendChild(uname);

    const contentDiv=document.createElement("div");
    contentDiv.className="content";
    if(msg.role==="Admin") contentDiv.innerHTML=msg.content;
    else contentDiv.textContent=msg.content;
    li.appendChild(contentDiv);

    // Admin/manager buttons and controls
    const controlsDiv=document.createElement("div");
    controlsDiv.className="adminControls";
    if(currentRole==="Admin" || currentRole==="Manager"){
        const pinBtn=document.createElement("button");
        pinBtn.textContent=msg.is_pinned?"Unpin":"Pin";
        pinBtn.onclick=async()=>{
            await supabaseClient.from("messages").update({is_pinned:!msg.is_pinned}).eq("id",msg.id);
        };
        controlsDiv.appendChild(pinBtn);

        const deleteBtn=document.createElement("button");
        deleteBtn.textContent="Delete";
        deleteBtn.onclick=async()=>{
            await supabaseClient.from("messages").delete().eq("id",msg.id);
        };
        controlsDiv.appendChild(deleteBtn);
    }
    li.appendChild(controlsDiv);
}

// Realtime updates
function initRealtime(){
    if(channel) return;
    channel = supabaseClient.channel("messages-channel")
        .on("postgres_changes",{event:"*",schema:"public",table:"messages"},payload=>{
            const newMsg=payload.new||payload.record;
            const type=payload.eventType;
            if(!newMsg) return;
            if(type==="INSERT"||type==="UPDATE") renderMessage(newMsg);
            else if(type==="DELETE"){ const li=messagesMap.get(newMsg.id); if(li){ li.remove(); messagesMap.delete(newMsg.id); } }
            log(`ðŸ“¡ Live update: ${type}`);
        })
        .subscribe(status=>{
            if(status==="SUBSCRIBED") log("âœ… Subscribed to live updates");
            else if(status==="CLOSED") log("ðŸ”´ Connection closed");
        });
}
</script>
</body>
</html>
