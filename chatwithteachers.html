<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/supabase.min.js"></script>
<script>
/* ============================================================
   CHAT CORE - FULL VERBOSE DEBUG
   ============================================================ */

const SUPABASE_URL = "https://qjajtkdchvapthnidtwj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M";

let supabase;
let username = localStorage.getItem("chatUsername") || "";
let currentRole = localStorage.getItem("chatRole") || null;
let isAdmin = false;
let userIp = "unknown";
let messagesChannel = null;
let realtimeReady = false;

// DOM elements
const input = document.getElementById("messageInput");
const button = document.getElementById("sendButton");
const messagesList = document.getElementById("messages");
const logBox = document.getElementById("logBox");
const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameButton");

// ============================================================
// VERBOSE LOGGING SYSTEM
// ============================================================
function escapeHtml(str = "") {
  return String(str).replace(/[&<>"']/g, m => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
  }[m]));
}

function log(msg, obj = null, level = "info", ctx = "") {
  const now = new Date();
  const time = `${now.toLocaleTimeString()}.${now.getMilliseconds()}`;
  const colors = { info: "#0f0", warn: "#ff0", error: "#f00", debug: "#0ff" };
  const color = colors[level] || "#0f0";

  const wrap = document.createElement("div");
  wrap.style.borderBottom = "1px solid #333";
  wrap.style.padding = "2px 0";
  wrap.innerHTML = `<div><b style="color:${color}">[${time}] ${level.toUpperCase()}</b> 
    ${ctx ? `<em style="color:#aaa">(${ctx})</em>` : ""}</div>
    <div style="margin-left:6px">${escapeHtml(String(msg))}</div>`;
  if (obj) {
    const pre = document.createElement("pre");
    try { pre.textContent = JSON.stringify(obj, null, 2); }
    catch { pre.textContent = String(obj); }
    pre.style.background = "#111";
    pre.style.color = "#0f0";
    pre.style.padding = "4px";
    pre.style.overflowX = "auto";
    pre.style.fontSize = "11px";
    pre.style.maxHeight = "200px";
    wrap.appendChild(pre);
  }
  logBox.appendChild(wrap);
  if (logBox.children.length > 500) logBox.removeChild(logBox.firstChild);
  logBox.scrollTop = logBox.scrollHeight;
  logBox.style.display = "block"; // always show
}

// ============================================================
// SUPABASE INIT
// ============================================================
function initSupabase() {
  log("Initializing Supabase...", null, "debug", "init");
  if (!supabase) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    log("Supabase client created", null, "info", "init");
  }
}

// ============================================================
// USERNAME HANDLING
// ============================================================
async function saveName() {
  const val = nameInput.value.trim();
  log(`Attempting to save username: "${val}"`, null, "debug", "username");
  if (!val) return alert("Please enter your name!");

  username = val;
  currentRole = username.toLowerCase() === "frenchwizz" ? "Admin" : "User";
  isAdmin = currentRole === "Admin";

  localStorage.setItem("chatUsername", username);
  localStorage.setItem("chatRole", currentRole);

  namePrompt.style.display = "none";
  input.disabled = false;
  button.disabled = false;

  log(`Username saved as "${username}", role: ${currentRole}`, null, "info", "username");
  initSupabase();
  await verifyRealtimeConnection();
  await loadMessages();
}

// ============================================================
// CLEAR NAME SHORTCUT
// ============================================================
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.altKey && e.shiftKey && e.key.toLowerCase() === "t") {
    log("Manual clear name triggered via Ctrl+Alt+Shift+T", null, "warn", "username");
    localStorage.removeItem("chatUsername");
    localStorage.removeItem("chatRole");
    location.reload();
  }
});

// ============================================================
// REALTIME CONNECTION CHECK
// ============================================================
async function verifyRealtimeConnection() {
  if (!supabase) return log("Supabase not initialized for realtime", null, "error", "realtime");
  try {
    const testChannel = supabase.channel("debug-" + Math.random().toString(36).slice(2, 8));
    testChannel.on("system", { event: "connected" }, () => {
      realtimeReady = true;
      log("Realtime connection verified", null, "info", "realtime");
      testChannel.unsubscribe().catch(()=>{});
    }).subscribe();
    log("Subscribed to test realtime channel", null, "debug", "realtime");
  } catch (err) {
    log("Realtime connection failed", err, "error", "realtime");
  }
}

// ============================================================
// LOAD MESSAGES
// ============================================================
async function loadMessages() {
  log("Loading messages from Supabase...", null, "debug", "messages");
  if (!supabase) return log("Supabase not initialized for message load", null, "error", "messages");

  try {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .order("inserted_at", { ascending: true });
    if (error) return log("Failed to load messages", error, "error", "messages");

    log(`Loaded ${data.length} messages`, null, "info", "messages");
    messagesList.innerHTML = "";
    const pinned = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");

    for (const m of data) {
      const opts = pinned.includes(m.id) ? { treatAsPinnedLoad: true } : {};
      addMessage(m, opts);
    }

    if (!messagesChannel) {
      messagesChannel = supabase.channel("public:messages");
      messagesChannel
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, p => {
          log("Realtime INSERT event received", p.new, "debug", "messages");
          addMessage(p.new);
        })
        .on("postgres_changes", { event: "UPDATE", schema: "public", table: "messages" }, p => {
          log("Realtime UPDATE event received", p.new, "debug", "messages");
          addMessage(p.new);
        })
        .on("postgres_changes", { event: "DELETE", schema: "public", table: "messages" }, p => {
          log("Realtime DELETE event received", p.old, "debug", "messages");
          const n = document.getElementById("msg-" + p.old.id);
          if (n) n.remove();
        })
        .subscribe(() => log("Subscribed to realtime messages channel", null, "info", "realtime"));
    }

  } catch (err) {
    log("Exception during message load", err, "error", "messages");
  }
}

// ============================================================
// SEND MESSAGE
// ============================================================
async function sendMessage() {
  log("Attempting to send message...", { content: input.value }, "debug", "sendMessage");
  if (!supabase) {
    log("Supabase not ready", null, "error", "sendMessage");
    return alert("Supabase not ready!");
  }

  const text = input.value.trim();
  if (!text) return log("Empty message ignored", null, "warn", "sendMessage");
  const safe = isAdmin ? text : escapeHtml(text);

  try {
    const res = await supabase.from("messages").insert({
      content: safe, username, role: currentRole, ip: userIp
    }).select();
    if (res.error) log("Message send failed", res.error, "error", "sendMessage");
    else {
      log("Message sent successfully", res.data[0], "info", "sendMessage");
      addMessage(res.data[0]);
    }
  } catch (e) {
    log("Exception sending message", e, "error", "sendMessage");
  }
  input.value = "";
}

// ============================================================
// MESSAGE RENDERING + ADMIN CONTROLS
// ============================================================
function addMessage(msg, opts = {}) {
  log("Rendering message", msg, "debug", "addMessage");
  if (!msg || !msg.id) return log("Invalid message skipped", msg, "warn", "addMessage");

  const pinned = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");
  const existing = document.getElementById("msg-" + msg.id);
  if (existing) existing.remove();

  const li = document.createElement("li");
  li.id = "msg-" + msg.id;
  li.className = "msg " + (msg.role || "User");
  if (pinned.includes(msg.id) || opts.treatAsPinnedLoad) li.classList.add("pinned");

  const header = document.createElement("div");
  header.className = "msgHeader";
  header.innerHTML = `<b>${escapeHtml(msg.username || "Anon")}</b> 
    <span style="color:#888;font-size:0.8em">(${msg.role || "User"})</span>`;

  const body = document.createElement("div");
  body.className = "msgBody";
  body.innerHTML = msg.content || "";

  li.appendChild(header);
  li.appendChild(body);

  if (isAdmin) createAdminControls(li, msg);

  messagesList.appendChild(li);
  messagesList.scrollTop = messagesList.scrollHeight;
}

// ============================================================
// STARTUP
// ============================================================
document.addEventListener("DOMContentLoaded", async () => {
  log("DOM loaded", null, "debug", "startup");
  saveNameBtn.onclick = saveName;
  button.onclick = sendMessage;
  input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  initSupabase();

  const saved = localStorage.getItem("chatUsername");
  if (saved) {
    nameInput.value = saved;
    log(`Saved username detected: ${saved}`, null, "info", "startup");
    await saveName();
  } else {
    namePrompt.style.display = "block";
    input.disabled = true;
    button.disabled = true;
    log("Waiting for username entry...", null, "info", "startup");
  }

  fetch("https://api.ipify.org?format=json")
    .then(r => r.json())
    .then(d => { userIp = d.ip; log("IP fetched " + userIp, null, "info", "network"); })
    .catch(() => { userIp = "unknown"; log("IP fetch failed", null, "warn", "network"); });
});
</script>

  

</body>
</html>
