<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
/* --- styles unchanged --- */
#controls { display: none; opacity: 0; transition: opacity 0.4s ease; }
#controls.visible { display: flex; opacity: 1; }
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:block; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#5865f2; font-weight:700; color:#fff; } 
#messages li.manager { background:#2d7d46; font-weight:700; color:#fff; } 
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script type="module">
  const { createClient } = supabase;
  const input = document.getElementById("messageInput");
  const button = document.getElementById("sendButton");
  const messagesList = document.getElementById("messages");
  const logBox = document.getElementById("logBox");
  logBox.style.display = "none";
  
  const namePrompt = document.getElementById("namePrompt");
  const nameInput = document.getElementById("nameInput");
  const saveNameBtn = document.getElementById("saveNameButton");
  
  const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
  const supabaseKey = "sb_publishable_1HWGEhoX-b4jj05hDKsGYw_H004LgVz";
  const supabaseClient = createClient(supabaseUrl, supabaseKey);
  
  let currentUser = null; // Supabase auth user
  let currentRole = "User";
  const messagesMap = new Map();
  
  // ------------------------ Name Lock ------------------------
  function updateMessageLock() {
    const hasName = nameInput.value.trim().length > 0;
    input.disabled = !hasName;
    button.disabled = !hasName;
  }
  nameInput.addEventListener("input", updateMessageLock);
  updateMessageLock();
  
  // ------------------------ Logging ------------------------
  function log(msg, obj = null, type = "info") {
    const el = document.createElement("div");
    el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logBox.appendChild(el);
    logBox.scrollTop = logBox.scrollHeight;
    if (obj) console[type === "error" ? "error" : "log"](msg, obj);
  }
  
  // ------------------------ Load User ------------------------
  async function loadUser() {
    const { data: user } = await supabaseClient.auth.getUser();
    if (!user) {
      namePrompt.style.display = "block";
      input.disabled = true;
      button.disabled = true;
      return;
    }
    currentUser = user.user;
    
    // fetch username and role from users table
    let { data } = await supabaseClient
      .from("users")
      .select("username, role")
      .eq("id", currentUser.id)
      .maybeSingle();
    
    if (!data) {
      namePrompt.style.display = "block";
      input.disabled = true;
      button.disabled = true;
      return;
    }
    
    nameInput.value = data.username;
    currentRole = data.role || "User";
    namePrompt.style.display = "none";
    
    document.getElementById("controls").classList.add("visible");
    input.disabled = false;
    button.disabled = false;
    logBox.style.display = currentRole === "Admin" ? "block" : "none";
    
    loadMessages();
    initRealtime();
  }
  
  // ------------------------ Save Name ------------------------
  async function saveName() {
    const name = nameInput.value.trim();
    if (!name) return alert("Enter a name!");
    try {
      await supabaseClient.from("users").upsert({
        id: currentUser.id,
        username: name
      }, { onConflict: ["id"] });
      
      // fetch role
      const { data } = await supabaseClient.from("users")
        .select("role")
        .eq("id", currentUser.id)
        .maybeSingle();
      
      currentRole = data?.role || "User";
      
      namePrompt.style.display = "none";
      document.getElementById("controls").classList.add("visible");
      input.disabled = false;
      button.disabled = false;
      logBox.style.display = currentRole === "Admin" ? "block" : "none";
      updateMessageLock();
      alert(`Welcome, ${name}! You are a ${currentRole}.`);
    } catch(e) {
      console.error(e);
      alert("Failed to save name");
    }
  }
  
  saveNameBtn.addEventListener("click", saveName);
  
  // ------------------------ Load Messages ------------------------
  async function loadMessages() {
    const { data, error } = await supabaseClient
      .from("messages")
      .select(`id, content, is_pinned, inserted_at, user_id, users!inner(username, role)`)
      .order("inserted_at",{ascending:true});
    
    if (error) return log("âŒ Failed to load messages", error, "error");
    
    data.forEach(msg => {
      msg.username = msg.users.username;
      msg.role = msg.users.role;
      renderMessage(msg);
    });
    
    log("âœ… Messages loaded");
  }
  
  // ------------------------ Send Message ------------------------
  async function sendMessage() {
    const content = input.value.trim();
    if (!content || !currentUser) return;
    
    try {
      const { data: userData } = await supabaseClient.from("users")
        .select("blocked")
        .eq("id", currentUser.id)
        .maybeSingle();
      if (userData?.blocked) {
        alert("âŒ You are blocked from sending messages.");
        return;
      }
      
      let ip = "unknown";
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const ipData = await res.json();
        ip = ipData.ip || "unknown";
      } catch {}
      
      await supabaseClient.from("messages").insert({
        content,
        user_id: currentUser.id,
        is_pinned: false,
        ip
      }).select();
      
      input.value = "";
      log("âœ… Message sent to Supabase");
    } catch(e) {
      log("âŒ Failed to send message", e, "error");
    }
  }
  
  button.addEventListener("click", sendMessage);
  input.addEventListener("keypress", e => { if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMessage(); }});
  
  // ------------------------ Render Message ------------------------
  function renderMessage(msg) {
    let li = messagesMap.get(msg.id);
    const viewerRole = currentRole;
  
    if (!li) {
      li = document.createElement("li");
      messagesMap.set(msg.id, li);
      messagesList.appendChild(li);
    }
  
    li.innerHTML = "";
    li.className = "";
    if (msg.role === "Admin") li.classList.add("admin");
    else if (msg.role === "Manager") li.classList.add("manager");
    li.dataset.pinned = msg.is_pinned ? "true" : "false";
    if (msg.is_pinned) li.style.border = "2px solid red"; else li.style.border = "";
  
    const uname = document.createElement("div");
    uname.className = "username";
    uname.textContent = msg.username === "Frenchwizz" ? "Takeo" : msg.username;
    li.appendChild(uname);
  
    const contentDiv = document.createElement("div");
    contentDiv.className = "content";
    if (msg.role === "Admin") contentDiv.innerHTML = msg.content;
    else contentDiv.textContent = msg.content;
    li.appendChild(contentDiv);
    
    // --- admin/manager controls code unchanged ---
  }
  
  // ------------------------ Realtime ------------------------
  let channel = null;
  function initRealtime() {
    if (channel) return;
    channel = supabaseClient.channel("messages-channel")
      .on("postgres_changes", { event: "*", schema: "public", table: "messages" }, (payload) => {
        handleRealtimeMessage(payload.new || payload.record, payload.eventType);
        log(`ðŸ“¡ Live update: ${payload.eventType}`);
      })
      .subscribe(status => {
        if (status === "SUBSCRIBED") log("âœ… Subscribed to live updates");
        else if (status === "CLOSED") log("ðŸ”´ Connection closed");
      });
  }
  
  function handleRealtimeMessage(newMsg, eventType) {
    if (!newMsg) return;
    if(eventType==="INSERT") renderMessage(newMsg);
    else if(eventType==="UPDATE") renderMessage(newMsg);
    else if(eventType==="DELETE") {
      const li = messagesMap.get(newMsg.id);
      if(li) { li.remove(); messagesMap.delete(newMsg.id); }
    }
  }
  
  // ------------------------ Init ------------------------
  supabaseClient.auth.getUser().then(() => loadUser());

</script>
</body>
</html>
