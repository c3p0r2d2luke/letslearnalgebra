<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; } /* Discord blue for admin messages */
#messages li.manager { background:#43b581; font-weight:700; color:#fff; } /* green for managers */
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; } /* optional highlight effect */
</style>
</head>
<body>
<h1>Chat Room</h1>

<!-- Name prompt -->
<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="debugBox" style="color:#0f0; background:#111; padding:4px 6px; font-family:monospace; font-size:12px; margin-bottom:8px;"></div>

<!-- Controls (message input + send) -->
<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<!-- messages list -->
<ul id="messages"></ul>

<!-- verbose admin log -->
<div id="logBox"></div>

<script>
/* ----------------------------------------------------------------------
   Supabase client
   ---------------------------------------------------------------------- */
const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ----------------------------------------------------------------------
   DOM references
   ---------------------------------------------------------------------- */
const input = document.getElementById("messageInput");
const button = document.getElementById("sendButton");
const messagesList = document.getElementById("messages");
const logBox = document.getElementById("logBox");
const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameButton");
const debugBox = document.getElementById("debugBox");

/* ----------------------------------------------------------------------
   Local state
   ---------------------------------------------------------------------- */
let username = localStorage.getItem("chatUsername") || "";
let isAdmin = false;
let currentRole = localStorage.getItem("chatRole") || null;
let savedUsernameForAutoLogin = false;
let realtimeReady = false;
let messagesChannel = null;
let userIp = "unknown";

/* ----------------------------------------------------------------------
   SUPER VERBOSE ADMIN LOG BOX
   ---------------------------------------------------------------------- */
function log(msg, obj = null, level = "info", context = null) {
    const now = new Date();
    const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}.${now.getMilliseconds()}`;
    const colors = { info: "#0f0", warn: "#ff0", error: "#f00", debug: "#0ff" };
    const color = colors[level] || "#0f0";
    console.log(`[${timestamp}] ${level.toUpperCase()}${context ? " ("+context+")" : ""}: ${msg}`, obj);

    if (!isAdmin) return;

    const entry = document.createElement("div");
    entry.style.marginBottom = "6px";
    entry.style.borderBottom = "1px solid #333";
    entry.style.paddingBottom = "4px";
    entry.innerHTML = `
        <div>
            <strong style="color:${color}">[${timestamp}] ${level.toUpperCase()}</strong>
            ${context ? `<em style="color:#aaa">(${context})</em>` : ""}
        </div>
        <div style="margin-left:8px">${escapeHtml(String(msg))}</div>
    `;

    if(obj){
        const pre = document.createElement("pre");
        try { pre.textContent = JSON.stringify(obj,null,2); } catch(e){ pre.textContent = String(obj);}
        pre.style.background="#111"; pre.style.color="#0f0"; pre.style.padding="4px";
        pre.style.borderRadius="4px"; pre.style.overflowX="auto"; pre.style.fontSize="11px";
        pre.style.maxHeight="150px"; pre.style.overflowY="auto";
        entry.appendChild(pre);
    }

    const MAX_LOGS=100;
    if(logBox.children.length>MAX_LOGS) logBox.removeChild(logBox.firstChild);
    logBox.appendChild(entry);
    logBox.scrollTop = logBox.scrollHeight;
}

/* ----------------------------------------------------------------------
   Escape HTML helper
   ---------------------------------------------------------------------- */
function escapeHtml(str=""){ 
    return String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
}

/* ----------------------------------------------------------------------
   Fetch or create user record
   ---------------------------------------------------------------------- */
async function fetchOrCreateUserRecord(name) {
    if(!name) return { username: name, role: "User" };
    try {
        const { data, error } = await supabase.from("users")
            .select("username,role,blocked,forceLogout")
            .eq("username", name)
            .maybeSingle();
        if(error) log("❌ Error fetching user record", error, "error", "users");
        if(data){
            if(!data.role) data.role="User";
            return { username:data.username, role:data.role, blocked:data.blocked||false, forceLogout:data.forceLogout||false };
        } else {
            await supabase.from("users").upsert({ username:name, role:"User", blocked:false, forceLogout:false });
            return { username:name, role:"User", blocked:false, forceLogout:false };
        }
    } catch(e){ log("❌ Exception fetching/creating user", e, "error", "users"); return { username:name, role:"User" }; }
}

/* ----------------------------------------------------------------------
   Save username function with debug display
   ---------------------------------------------------------------------- */
async function saveName(){
    const val = nameInput.value.trim();
    if(!val) return alert("Name required!");
    username = val;

    // read or create user row
    const userRecord = await fetchOrCreateUserRecord(username);
    currentRoleFromRecord = userRecord.role || "User";
    currentRoleFromRecord = currentRoleFromRecord.charAt(0).toUpperCase() + currentRoleFromRecord.slice(1);

    try {
        localStorage.setItem("chatUsername", username);
        localStorage.setItem("chatRole", currentRoleFromRecord);
    } catch (e) {
        if(debugBox) debugBox.textContent = `⚠️ Could not persist to localStorage: ${e}`;
    }
    currentRole = currentRoleFromRecord;

    // Show debug info
    if(debugBox) debugBox.textContent = `✅ Saved username: "${username}", role: "${currentRoleFromRecord}"`;

    // local admin override (keeps backwards compatibility)
    if((username.toLowerCase()==="frenchwizz") || currentRole==="Admin"){
        isAdmin = true;
        logBox.style.display="block";
        log("Logged in as ADMIN.", null, "info", "auth");
    } else {
        isAdmin = false;
    }

    namePrompt.style.display="none";
    input.disabled=false;
    button.disabled=false;
    savedUsernameForAutoLogin=true;

    // load messages right away (subscribe + fetch)
    await loadMessages().catch(e => log("Error loading messages after saveName", e, "error", "messages"));
}

/* ----------------------------------------------------------------------
   DOM ready wiring + autologin
   ---------------------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
    // attach handlers
    if (saveNameBtn) saveNameBtn.onclick = saveName;
    if (button) button.addEventListener("click", sendMessage);
    if (input) input.addEventListener("keydown", (e) => { if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    // autologin if saved username exists in localStorage
    const saved = localStorage.getItem("chatUsername");
    if (saved) {
        username = saved;
        currentRole = localStorage.getItem("chatRole") || (username.toLowerCase()==="frenchwizz" ? "Admin" : "User");
        if(username.toLowerCase()==="frenchwizz" || currentRole === "Admin"){
            isAdmin = true;
            logBox.style.display = "block";
        }
        namePrompt.style.display = "none";
        input.disabled = false;
        button.disabled = false;
        savedUsernameForAutoLogin = true;
        if(debugBox) debugBox.textContent = `✅ Auto-logged as "${username}", role: "${currentRole}"`;
        // load messages immediately
        loadMessages().catch(e => log("Error loading messages on autologin", e, "error", "messages"));
    } else {
        // show prompt and disable controls until user saves name
        namePrompt.style.display = "block";
        input.disabled = true;
        button.disabled = true;
    }
});

/* ----------------------------------------------------------------------
    Enable Realtime helper (used by handshake)
   ---------------------------------------------------------------------- */
function enableUIAfterHandshake() {
    input.disabled = false;
    button.disabled = false;

    if(username && !messagesChannel) {
        if(realtimeReady) {
            loadMessages().catch(e => log("Error loading messages after handshake", e, "error", "messages"));
        } else {
            setTimeout(enableUIAfterHandshake, 1000);
        }
    }
}

/* ----------------------------------------------------------------------
   Realtime handshake test — sets realtimeReady when socket is available
   ---------------------------------------------------------------------- */
async function verifyRealtimeConnection() {
    try {
        const testChannel = supabase.channel("debug-connection-" + Math.random().toString(36).slice(2,8));
        testChannel
            .on("system", { event: "connected" }, () => {
                realtimeReady = true;
                log("✅ Realtime connection established", null, "info", "realtime");
                if(savedUsernameForAutoLogin) enableUIAfterHandshake();
                testChannel.unsubscribe().catch(()=>{});
            })
            .on("system", { event: "heartbeat" }, () => {
                // no-op
            })
            .subscribe();
    } catch (err) {
        log("Realtime connection test failed", err, "error", "realtime");
    }
}
verifyRealtimeConnection();

/* ----------------------------------------------------------------------
   loadMessages + subscribe to realtime
   ---------------------------------------------------------------------- */
async function loadMessages() {
    if (!username) return;

    if (!messagesChannel) {
        messagesChannel = supabase.channel("public:messages");
        messagesChannel
            .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => addMessage(payload.new))
            .on("postgres_changes", { event: "UPDATE", schema: "public", table: "messages" }, payload => addMessage(payload.new))
            .on("postgres_changes", { event: "DELETE", schema: "public", table: "messages" }, payload => {
                const node = document.getElementById("msg-"+payload.old.id);
                if(node) node.remove();
            })
            .subscribe((status) => {
                log(`Realtime subscription status: ${status}`, null, "debug", "messages");
                if (status === "SUBSCRIBED") {
                    log("✅ Realtime subscription confirmed (messages channel)", null, "info", "messages");
                } else if (status === "CHANNEL_ERROR") {
                    log("❌ Realtime subscription error (messages channel)", null, "error", "messages");
                } else if (status === "CLOSED") {
                    log("⚠️ Realtime subscription closed", null, "warn", "messages");
                }
            });
    }

    // fetch existing messages once
    try {
        const { data, error } = await supabase.from("messages").select().order("inserted_at", { ascending: true });
        if (error) {
            log("❌ Failed to load messages", error, "error", "messages");
        } else {
            data.forEach(msg => addMessage(msg));
        }
    } catch (e) {
        log("❌ Exception loading messages", e, "error", "messages");
    }
}

/* ----------------------------------------------------------------------
   Render a message to DOM
   - Render HTML only when message is from 'Frenchwizz' OR msg.role === 'Admin'
   ---------------------------------------------------------------------- */
function addMessage(msg){
    if(!msg || !msg.id) return;

    const msgRole = msg.role || "User";
    const displayName = (msg.username === "Frenchwizz") ? "Takeo" : (msg.username || "Unknown");
    const isMsgAdmin = (msg.username === "Frenchwizz") || (String(msgRole).toLowerCase() === "admin");

    // remove existing if re-rendering updated message
    const existing = document.getElementById("msg-"+msg.id);
    if(existing) existing.remove();

    const li = document.createElement("li");
    li.id = "msg-" + msg.id;

    if(isMsgAdmin) li.classList.add("admin");
    else if(msgRole === "Manager") li.classList.add("manager");

    if(isMsgAdmin) {
        // render raw HTML for admin messages (trusted per your request)
        li.innerHTML = `
            <div class="username">${escapeHtml(displayName)}</div>
            <div class="content">${msg.content || ""}</div>
            <div class="timestamp">${msg.inserted_at ? new Date(msg.inserted_at).toLocaleTimeString() : "?"}</div>
            <span class="userIp">${escapeHtml(msg.ip || "unknown")}</span>
            ${isAdmin ? `<div class="adminControls"></div>` : ""}
        `;
    } else {
        // escape content for non-admins
        li.innerHTML = `
            <div class="username">${escapeHtml(displayName)}</div>
            <div class="content">${escapeHtml(msg.content || "")}</div>
            <div class="timestamp">${msg.inserted_at ? new Date(msg.inserted_at).toLocaleTimeString() : "?"}</div>
            <span class="userIp">${escapeHtml(msg.ip || "unknown")}</span>
            ${isAdmin ? `<div class="adminControls"></div>` : ""}
        `;
    }

    messagesList.appendChild(li);
    messagesList.scrollTop = messagesList.scrollHeight;
}

/* ----------------------------------------------------------------------
   Send message (stores role snapshot so admin HTML renders when appropriate)
   ---------------------------------------------------------------------- */
async function sendMessage(){
    const text = input.value.replace(/\r/g,"").trim();
    if(!text) return;

    // normalize role snapshot
    const roleToSave = isAdmin ? "Admin" : (currentRole ? (currentRole.charAt(0).toUpperCase() + currentRole.slice(1)) : "User");

    try {
        const { data, error } = await supabase
            .from("messages")
            .insert({ content: text, username, ip: userIp, role: roleToSave })
            .select();

        if (error) {
            log("❌ Message failed to send", error, "error", "messages");
        } else {
            log("✅ Message sent successfully", null, "info", "messages");
            if (Array.isArray(data) && data[0]) addMessage(data[0]);
        }
    } catch (e) {
        log("❌ Exception inserting message", e, "error", "messages");
    }

    input.value = "";
}

</script>

</body>
</html>
