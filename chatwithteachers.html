<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat Room with Admin Controls</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.76.1/dist/umd/supabase.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:block; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; cursor:pointer; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.adminControls { display:none; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
li.pinned { border-left: 4px solid #f39c12; }
</style>
</head>
<body>

<h1>Chat Room</h1>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>
<div id="logBox"></div>

<script>
const SUPABASE_URL = "https://qjajtkdchvapthnidtwj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M";

let supabase, username, currentRole, isAdmin;
let messagesChannel = null;
let userIp = "unknown";

const logBox = document.getElementById("logBox");
const input = document.getElementById("messageInput");
const button = document.getElementById("sendButton");
const messagesList = document.getElementById("messages");

function log(msg, obj=null, level="debug") {
    const time = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.innerHTML = `[${time}] ${level.toUpperCase()}: ${msg}`;
    logBox.appendChild(div);
    if(obj) {
        const pre = document.createElement("pre");
        pre.textContent = JSON.stringify(obj,null,2);
        logBox.appendChild(pre);
    }
    logBox.scrollTop = logBox.scrollHeight;
}

function initSupabase() {
    log("Initializing Supabase...", null, "debug");
    try {
        supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);
        log("Supabase initialized successfully", {supabaseUrl: SUPABASE_URL}, "info");
    } catch(err) {
        log("Supabase initialization failed", err, "error");
    }
}

async function loadMessages() {
    if (!supabase) return log("Supabase not ready", null, "error");
    try {
        const { data, error } = await supabase.from("messages").select("*").order("inserted_at", {ascending:true});
        if(error) return log("Failed to load messages", error, "error");
        messagesList.innerHTML = "";
        const pinned = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");
        data.forEach(m => addMessage(m, { treatAsPinnedLoad: pinned.includes(m.id) }));
        if(!messagesChannel) subscribeToRealtime();
    } catch(e) {
        log("Exception loading messages", e, "error");
    }
}

function addMessage(msg, opts={}) {
    if(!msg || !msg.id) return;
    const li = document.createElement("li");
    li.id = "msg-" + msg.id;
    li.className = msg.role || "User";
    if(opts.treatAsPinnedLoad) li.classList.add("pinned");

    const header = document.createElement("div");
    header.className = "username";
    header.textContent = msg.username + " (" + (msg.role || "User") + ")";
    const body = document.createElement("div");
    body.className = "content";
    body.textContent = msg.content;

    li.appendChild(header);
    li.appendChild(body);

    if(isAdmin) createAdminControls(li, msg);

    messagesList.appendChild(li);
    li.addEventListener("click", () => {
        if(isAdmin) {
            const controls = li.querySelector(".adminControls");
            if(controls) controls.style.display = controls.style.display === "flex" ? "none" : "flex";
        }
    });

    messagesList.scrollTop = messagesList.scrollHeight;
}

function createAdminControls(li, msg) {
    const controls = document.createElement("div");
    controls.className = "adminControls";

    const mkBtn = (text, handler, color="#666") => {
        const b = document.createElement("button");
        b.textContent = text;
        b.style.background = color;
        b.style.color = "#fff";
        b.onclick = handler;
        return b;
    };

    // Delete
    controls.appendChild(mkBtn("Delete", async () => {
        try {
            await supabase.from("messages").delete().eq("id", msg.id);
            li.remove();
            log(`Deleted message #${msg.id}`, msg, "info");
        } catch(err) { log("Delete failed", err, "error"); }
    }, "#c33"));

    // Pin/Unpin
    const pinnedList = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");
    const isPinned = pinnedList.includes(msg.id);
    controls.appendChild(mkBtn(isPinned ? "Unpin" : "Pin", () => {
        const list = JSON.parse(localStorage.getItem("pinnedMessages") || "[]");
        if(isPinned) {
            const idx = list.indexOf(msg.id); if(idx>=0) list.splice(idx,1);
            li.classList.remove("pinned");
        } else {
            list.push(msg.id);
            li.classList.add("pinned");
        }
        localStorage.setItem("pinnedMessages", JSON.stringify(list));
        log(`${isPinned ? "Unpinned" : "Pinned"} #${msg.id}`, null, "info");
    }, "#3c3"));

    // Mute/Unmute (client only)
    const mutedList = JSON.parse(localStorage.getItem("mutedUsers") || "[]");
    const isMuted = mutedList.includes(msg.username);
    controls.appendChild(mkBtn(isMuted ? "Unmute" : "Mute", () => {
        const list = JSON.parse(localStorage.getItem("mutedUsers") || "[]");
        if(isMuted) {
            const idx = list.indexOf(msg.username); if(idx>=0) list.splice(idx,1);
        } else list.push(msg.username);
        localStorage.setItem("mutedUsers", JSON.stringify(list));
        log(`${isMuted ? "Unmuted" : "Muted"} ${msg.username}`, null, "debug");
    }, "#09c"));

    // Promote/Demote
    controls.appendChild(mkBtn("Promote", async () => {
        try {
            await supabase.from("messages").update({role:"Admin"}).eq("username", msg.username);
            log(`Promoted ${msg.username}`, null, "info");
        } catch(err) { log("Promote failed", err, "error"); }
    }, "#b5a"));

    controls.appendChild(mkBtn("Demote", async () => {
        try {
            await supabase.from("messages").update({role:"User"}).eq("username", msg.username);
            log(`Demoted ${msg.username}`, null, "info");
        } catch(err) { log("Demote failed", err, "error"); }
    }, "#a55"));

    li.appendChild(controls);
}

async function sendMessage() {
    if(!supabase) return log("Supabase not ready", null, "error");
    const text = input.value.trim();
    if(!text) return;
    try {
        const { data, error } = await supabase.from("messages").insert([{username, content:text, role:currentRole, ip:userIp}]);
        if(error) return log("Failed to send message", error, "error");
        input.value = "";
        log(`Message sent`, data, "info");
    } catch(e) { log("Exception sending message", e, "error"); }
}

function subscribeToRealtime() {
    messagesChannel = supabase.channel("public:messages").on("postgres_changes", { event: "*", schema:"public", table:"messages" }, payload => {
        addMessage(payload.new);
        log("Realtime update", payload, "debug");
    }).subscribe();
}

document.addEventListener("DOMContentLoaded", () => {
    log("DOM loaded", null, "debug");
    const saved = localStorage.getItem("chatUsername");
    if(saved) {
        username = saved;
        currentRole = username.toLowerCase() === "frenchwizz" ? "Admin" : "User";
        isAdmin = currentRole === "Admin";
        log(`Loaded saved username: "${username}", role: ${currentRole}`, null, "info");
    } else {
        username = prompt("Enter your name:");
        localStorage.setItem("chatUsername", username);
        currentRole = username.toLowerCase() === "frenchwizz" ? "Admin" : "User";
        isAdmin = currentRole === "Admin";
        log(`Username set: "${username}", role: ${currentRole}`, null, "info");
    }
    input.disabled = false;
    button.disabled = false;
    button.onclick = sendMessage;
    initSupabase();
    loadMessages();

    // Shortcut to clear name
    document.addEventListener("keydown", e => {
        if(e.ctrlKey && e.altKey && e.shiftKey && e.key.toLowerCase() === "t") {
            username = null;
            currentRole = "User";
            isAdmin = false;
            localStorage.removeItem("chatUsername");
            log("Username cleared via Ctrl+Alt+Shift+T", null, "info");
            location.reload();
        }
    });
});
</script>
</body>
</html>
