<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; } /* Discord blue for admin messages */
#messages li.manager { background:#43b581; font-weight:700; color:#fff; } /* green for managers */
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; } /* optional highlight effect */
</style>
</head>
<body>
<h1>Chat Room</h1>

<!-- Name prompt -->
<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<!-- Controls (message input + send) -->
<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<!-- messages list -->
<ul id="messages"></ul>

<!-- verbose admin log -->
<div id="logBox"></div>

<script>
    /* ----------------------------------------------------------------------
       Supabase client
       ---------------------------------------------------------------------- */
    const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    /* ----------------------------------------------------------------------
       DOM references
       ---------------------------------------------------------------------- */
    const input = document.getElementById("messageInput");
    const button = document.getElementById("sendButton");
    const messagesList = document.getElementById("messages");
    const logBox = document.getElementById("logBox");
    const namePrompt = document.getElementById("namePrompt");
    const nameInput = document.getElementById("nameInput");
    const saveNameBtn = document.getElementById("saveNameButton");
    const debugBox = document.getElementById("debugBox"); // optional debug area if present
    
    /* ----------------------------------------------------------------------
       Local state
       ---------------------------------------------------------------------- */
    let username = localStorage.getItem("chatUsername") || "";
    let isAdmin = false;
    let currentRole = localStorage.getItem("chatRole") || null;
    let savedUsernameForAutoLogin = false;
    let realtimeReady = false;
    let messagesChannel = null;
    let userIp = "unknown";
    
    /* ----------------------------------------------------------------------
       Logging + debug box (admin-only visible)
       ---------------------------------------------------------------------- */
    function escapeHtml(str=""){
        return String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function log(msg, obj=null, level="info", context=null){
        const now = new Date();
        const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}.${now.getMilliseconds()}`;
        const colors = { info:"#0f0", warn:"#ff0", error:"#f00", debug:"#0ff" };
        const color = colors[level]||"#0f0";
        console.log(`[${timestamp}] ${level.toUpperCase()}${context ? " ("+context+")" : ""}:`, msg, obj);
        if(!isAdmin) return;
        const entry = document.createElement("div");
        entry.style.marginBottom = "6px";
        entry.style.borderBottom = "1px solid #333";
        entry.style.paddingBottom = "4px";
        entry.innerHTML = `
            <div><strong style="color:${color}">[${timestamp}] ${level.toUpperCase()}</strong> ${context ? `<em style="color:#aaa">(${context})</em>` : ""}</div>
            <div style="margin-left:8px">${escapeHtml(String(msg))}</div>
        `;
        if(obj){
            const pre = document.createElement("pre");
            try { pre.textContent = JSON.stringify(obj, null, 2); } catch(e){ pre.textContent = String(obj); }
            pre.style.background="#111"; pre.style.color="#0f0"; pre.style.padding="4px"; pre.style.borderRadius="4px"; pre.style.overflowX="auto"; pre.style.fontSize="11px"; pre.style.maxHeight="150px"; pre.style.overflowY="auto";
            entry.appendChild(pre);
        }
        const MAX_LOGS = 200;
        if(logBox.children.length > MAX_LOGS) logBox.removeChild(logBox.firstChild);
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
    }
    
    /* ----------------------------------------------------------------------
       Optional bad-word filter + alert (keeps the original behavior)
       ---------------------------------------------------------------------- */
    const badWords = ["badword1","badword2","badword3"];
    async function sendBadWordAlert(user, word, original){
        try {
            const payload = { to: "frenchwizz@proton.me", subject: `üö® Bad word detected: ${word}`, text: `${user} used "${word}" in message:\n\n${original}` };
            const res = await supabase.functions.invoke("sendEmail", { body: payload });
            if(res.error) log("‚ùå sendEmail function returned error", res.error, "error", "badwords");
            else log("‚úâÔ∏è Bad-word alert emailed", { user, word }, "info", "badwords");
        } catch (err) {
            log("‚ùå Failed to call sendEmail edge function", err, "error", "badwords");
        }
    }
    function filterMessage(content){
        if(!content) return "";
        let clean = content;
        badWords.forEach(word => {
            const esc = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(esc, "gi");
            if(regex.test(clean)){
                clean = clean.replace(regex, (m)=>"*".repeat(m.length));
                sendBadWordAlert(username || "Unknown", word, content).catch(e => log("Error sending badword alert", e, "error", "badwords"));
            }
        });
        return clean;
    }
    
    /* ----------------------------------------------------------------------
       Fetch or create user record in users table
       ---------------------------------------------------------------------- */
    async function fetchOrCreateUserRecord(name){
        if(!name) return { username: name, role: "User" };
        try {
            const { data, error } = await supabase.from("users").select("username,role,blocked,forceLogout").eq("username", name).maybeSingle();
            if(error) log("‚ùå Error fetching user record", error, "error", "users");
            if(data){
                if(!data.role) data.role = "User";
                return { username: data.username, role: data.role, blocked: !!data.blocked, forceLogout: !!data.forceLogout };
            } else {
                const up = await supabase.from("users").upsert({ username: name, role: "User", blocked:false, forceLogout:false });
                if(up.error) log("‚ùå Error upserting default user", up.error, "error", "users");
                return { username: name, role: "User", blocked:false, forceLogout:false };
            }
        } catch(e){
            log("‚ùå Exception fetching/creating user", e, "error", "users");
            return { username: name, role: "User" };
        }
    }
    
    /* ----------------------------------------------------------------------
       Save username (onboarding)
       ---------------------------------------------------------------------- */
       async function saveName() {
    const val = nameInput.value.trim();

    if (val.toLowerCase() === "takeo") {
        alert("You're not the admin!");
        return; // stops the login
    }

    if (!val) return alert("Name required!");

    username = val;

    const userRecord = await fetchOrCreateUserRecord(username);
    let roleFromDb = (userRecord.role || "User");
    roleFromDb = roleFromDb.charAt(0).toUpperCase() + roleFromDb.slice(1);
    currentRole = roleFromDb;

    try {
        localStorage.setItem("chatUsername", username);
        localStorage.setItem("chatRole", currentRole);
    } catch(e) {
        if(debugBox) debugBox.textContent = `‚ö†Ô∏è Could not persist to localStorage: ${e}`;
    }

    isAdmin = (username.toLowerCase() === "frenchwizz") || (currentRole === "Admin");
    logBox.style.display = isAdmin ? "block" : "none";
    if(isAdmin) log("Logged in as ADMIN.", null, "info", "auth");

    namePrompt.style.display = "none";
    input.disabled = false;
    button.disabled = false;
    savedUsernameForAutoLogin = true;

    // show debug
    if(debugBox) debugBox.textContent = `‚úÖ Saved username: "${username}", role: "${currentRole}"`;

    // load messages and subscribe
    await loadMessages();
}

    
    /* ----------------------------------------------------------------------
       DOM wiring & autologin
       ---------------------------------------------------------------------- */
    document.addEventListener("DOMContentLoaded", ()=>{
        if(saveNameBtn) saveNameBtn.onclick = saveName;
        if(button) button.addEventListener("click", sendMessage);
        if(input) input.addEventListener("keydown", (e)=>{ if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
    
        // autologin if saved
        const saved = localStorage.getItem("chatUsername");
        if(saved){
            username = saved;
            currentRole = localStorage.getItem("chatRole") || (username.toLowerCase()==="frenchwizz" ? "Admin" : "User");
            isAdmin = (username.toLowerCase()==="frenchwizz" || currentRole === "Admin");
            logBox.style.display = isAdmin ? "block" : "none";
            namePrompt.style.display = "none";
            input.disabled = false;
            button.disabled = false;
            savedUsernameForAutoLogin = true;
            if(debugBox) debugBox.textContent = `‚úÖ Auto-logged as "${username}", role: "${currentRole}"`;
            loadMessages().catch(e=>log("Error loading messages on autologin", e, "error", "messages"));
        } else {
            namePrompt.style.display = "block";
            input.disabled = true;
            button.disabled = true;
        }
    });
    
    /* ----------------------------------------------------------------------
       Realtime connection test (handshake)
       ---------------------------------------------------------------------- */
    async function verifyRealtimeConnection(){
        try {
            const testChannel = supabase.channel("debug-connection-" + Math.random().toString(36).slice(2,8));
            testChannel.on("system", { event: "connected" }, () => {
                realtimeReady = true;
                log("‚úÖ Realtime connection established", null, "info", "realtime");
                if(savedUsernameForAutoLogin) enableUIAfterHandshake();
                testChannel.unsubscribe().catch(()=>{});
            }).subscribe();
        } catch(err){
            log("Realtime connection test failed", err, "error", "realtime");
        }
    }
    verifyRealtimeConnection();
    
    function enableUIAfterHandshake(){
        input.disabled = false;
        button.disabled = false;
        if(username && !messagesChannel){
            if(realtimeReady) loadMessages().catch(e=>log("Error loading messages after handshake", e, "error", "messages"));
            else setTimeout(enableUIAfterHandshake, 1000);
        }
    }
    
    /* ----------------------------------------------------------------------
       loadMessages + Realtime subscription (creates single channel)
       ---------------------------------------------------------------------- */
    async function loadMessages(){
        if(!username) return;
    
        // fetch existing messages (once)
        try {
            const { data, error } = await supabase.from("messages").select().order("inserted_at", { ascending: true });
            if(error){
                log("‚ùå Failed to load messages", error, "error", "messages");
            } else {
                // render in order
                data.forEach(m => addMessage(m));
            }
        } catch(e){
            log("‚ùå Exception loading messages", e, "error", "messages");
        }
    
        // subscribe to realtime if not already
        if(!messagesChannel){
            messagesChannel = supabase.channel("public:messages");
            messagesChannel
                .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
                    // ignore if we already have it rendered (addMessage will dedupe by id)
                    addMessage(payload.new);
                })
                .on("postgres_changes", { event: "UPDATE", schema: "public", table: "messages" }, payload => {
                    addMessage(payload.new);
                })
                .on("postgres_changes", { event: "DELETE", schema: "public", table: "messages" }, payload => {
                    const node = document.getElementById("msg-"+payload.old.id);
                    if(node) node.remove();
                })
                .subscribe((status) => {
                    log(`Realtime subscription status: ${status}`, null, "debug", "messages");
                    if (status === "SUBSCRIBED") log("‚úÖ Realtime subscription confirmed (messages channel)", null, "info", "messages");
                    else if (status === "CHANNEL_ERROR") log("‚ùå Realtime subscription error (messages channel)", null, "error", "messages");
                    else if (status === "CLOSED") log("‚ö†Ô∏è Realtime subscription closed", null, "warn", "messages");
                });
        }
    }
    
    /* ----------------------------------------------------------------------
       Render message to DOM
       - Render HTML for messages from Frenchwizz OR msg.role === 'Admin'
       - Map display name Frenchwizz -> Takeo
       ---------------------------------------------------------------------- */
    function addMessage(msg){
        if(!msg || !msg.id) return;
    
        const msgRole = msg.role || "User";
        const displayName = msg.username === "Frenchwizz" ? "Takeo" : (msg.username || "Unknown");
        const isMsgAdmin = (msg.username === "Frenchwizz") || (String(msgRole).toLowerCase() === "admin");
    
        // remove previous (for updates)
        const existing = document.getElementById("msg-"+msg.id);
        if(existing) existing.remove();
    
        const li = document.createElement("li");
        li.id = "msg-" + msg.id;
    
        if(isMsgAdmin) li.classList.add("admin");
        else if(msgRole === "Manager") li.classList.add("manager");
    
        if(isMsgAdmin){
            // NOTE: trusting admin content to render as HTML per your request
            li.innerHTML = `
                <div class="username">${escapeHtml(displayName)}</div>
                <div class="content">${msg.content || ""}</div>
                <div class="timestamp">${msg.inserted_at ? new Date(msg.inserted_at).toLocaleTimeString() : "?"}</div>
                <span class="userIp">${escapeHtml(msg.ip || "unknown")}</span>
                ${isAdmin ? `<div class="adminControls"></div>` : ""}
            `;
        } else {
            // escape content for everyone else
            li.innerHTML = `
                <div class="username">${escapeHtml(displayName)}</div>
                <div class="content">${escapeHtml(msg.content || "")}</div>
                <div class="timestamp">${msg.inserted_at ? new Date(msg.inserted_at).toLocaleTimeString() : "?"}</div>
                <span class="userIp">${escapeHtml(msg.ip || "unknown")}</span>
                ${isAdmin ? `<div class="adminControls"></div>` : ""}
            `;
        }
    
        messagesList.appendChild(li);
        messagesList.scrollTop = messagesList.scrollHeight;
    
        // attach admin controls if viewer is admin
        if(isAdmin) createAdminControls(li, msg);
    }
    
    /* ----------------------------------------------------------------------
       Send message
       - tries with role column, retries without role if schema lacks it
       ---------------------------------------------------------------------- */
    async function sendMessage(){
        const text = input.value.replace(/\r/g,"").trim();
        if(!text) return;
    
        // check if muted/blocked/forceLogout could be added here (omitted for brevity)
    
        // choose whether to filter bad words for non-admins
        const clean = isAdmin ? text : filterMessage(text);
    
        const roleToSave = isAdmin ? "Admin" : (currentRole ? (currentRole.charAt(0).toUpperCase() + currentRole.slice(1)) : "User");
    
        // first attempt: include role
        try {
            let res = await supabase.from("messages").insert({ content: clean, username, ip: userIp, role: roleToSave }).select();
            if(res.error){
                // handle missing column error (PostgREST PGRST204) by retrying without role
                if(String(res.error.code || "").toUpperCase().includes("PGRST204") || /Could not find the 'role' column/i.test(String(res.error.message || ""))){
                    log("Role column missing ‚Äî retrying insert without role", res.error, "warn", "messages");
                    const retry = await supabase.from("messages").insert({ content: clean, username, ip: userIp }).select();
                    if(retry.error) log("‚ùå Message failed to send (retry)", retry.error, "error", "messages");
                    else {
                        if(Array.isArray(retry.data) && retry.data[0]) addMessage(retry.data[0]);
                        log("‚úÖ Message sent (retry without role)", null, "info", "messages");
                    }
                } else {
                    log("‚ùå Message failed to send", res.error, "error", "messages");
                }
            } else {
                if(Array.isArray(res.data) && res.data[0]) addMessage(res.data[0]);
                log("‚úÖ Message sent successfully", null, "info", "messages");
            }
        } catch(e){
            log("‚ùå Exception inserting message", e, "error", "messages");
        }
    
        input.value = "";
    }
    
    /* ----------------------------------------------------------------------
       Create admin controls inside each message LI (all original buttons)
       ---------------------------------------------------------------------- */
    function createAdminControls(li, msg){
        if(!isAdmin) return;
        const adminDiv = li.querySelector(".adminControls");
        if(!adminDiv) return;
    
        adminDiv.style.display = "none"; // hidden by default; can be toggled by UI if you want
    
        // Delete (single)
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
            try {
                const { error } = await supabase.from("messages").delete().eq("id", msg.id);
                if(error) log("‚ùå Failed to delete message", error, "error", "admin");
                else {
                    li.remove();
                    log(`üóë Deleted message id=${msg.id}`, null, "warn", "admin");
                }
            } catch(e){ log("‚ùå Exception deleting message", e, "error", "admin"); }
        };
        adminDiv.appendChild(delBtn);
    
        // Edit
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.onclick = async () => {
            const newText = prompt("Edit message:", msg.content || "");
            if(newText === null) return;
            try {
                const { error } = await supabase.from("messages").update({ content: newText }).eq("id", msg.id);
                if(error) log("‚ùå Failed editing message", error, "error", "admin");
                else {
                    // update UI
                    const contentEl = li.querySelector(".content");
                    if(contentEl) {
                        if( (msg.username === "Frenchwizz") || (String(msg.role).toLowerCase() === "admin")) {
                            // admin message: display raw HTML
                            contentEl.innerHTML = newText;
                        } else {
                            contentEl.textContent = newText;
                        }
                    }
                    log(`‚úèÔ∏è Edited message id=${msg.id}`, { newText }, "info", "admin");
                }
            } catch(e){ log("‚ùå Exception editing message", e, "error", "admin"); }
        };
        adminDiv.appendChild(editBtn);
    
        // Change Name (rename user)
        const nameBtn = document.createElement("button");
        nameBtn.textContent = "Change Name";
        nameBtn.onclick = async () => {
            const newName = prompt("New username for "+msg.username+":", msg.username);
            if(!newName) return;
            try {
                await supabase.from("users").upsert({ username: newName, blocked: false });
                await supabase.from("messages").update({ username: newName }).eq("username", msg.username);
                // update UI text nodes where applicable
                document.querySelectorAll("#messages li").forEach(liItem=>{
                    const el = liItem.querySelector(".username");
                    if(el && el.textContent === msg.username) el.textContent = newName;
                });
                log(`üîÅ Changed username ${msg.username} ‚Üí ${newName}`, null, "info", "admin");
            } catch(e){ log("‚ùå Failed to change name", e, "error", "admin"); }
        };
        adminDiv.appendChild(nameBtn);
    
        // Toggle Block
        const blockBtn = document.createElement("button");
        blockBtn.textContent = "Toggle Block";
        blockBtn.onclick = async () => {
            try {
                const { data: userRow } = await supabase.from("users").select("blocked").eq("username", msg.username).maybeSingle();
                const blockedNow = !(userRow?.blocked || false);
                await supabase.from("users").update({ blocked: blockedNow }).eq("username", msg.username);
                alert(`${msg.username} is now ${blockedNow ? "blocked" : "unblocked"}`);
                log(`üîí ${blockedNow ? "Blocked" : "Unblocked"} ${msg.username}`, null, "warn", "admin");
            } catch(e){ log("‚ùå Failed toggling block", e, "error", "admin"); }
        };
        adminDiv.appendChild(blockBtn);
    
        // Force Logout
        const logoutBtn = document.createElement("button");
        logoutBtn.textContent = "Force Logout";
        logoutBtn.onclick = async () => {
            if(msg.username === username){ alert("You cannot force logout yourself."); return; }
            try {
                await supabase.from("users").update({ forceLogout: true }).eq("username", msg.username);
                alert(`${msg.username} has been forced to log out.`);
                log(`üîå Forced logout for ${msg.username}`, null, "warn", "admin");
            } catch(e){ log("‚ùå Failed to force logout", e, "error", "admin"); }
        };
        adminDiv.appendChild(logoutBtn);
    
        // Mute
        const muteBtn = document.createElement("button");
        muteBtn.textContent = "Mute 5min";
        muteBtn.onclick = () => {
            // local mute implementation (best-effort)
            const mutedUsers = window.__mutedUsers = window.__mutedUsers || {};
            mutedUsers[msg.username] = Date.now() + 5*60*1000;
            alert(`${msg.username} muted for 5 minutes`);
            log(`üîá Muted ${msg.username} for 5 minutes`, null, "info", "admin");
        };
        adminDiv.appendChild(muteBtn);
    
        // Export Chat
        const exportBtn = document.createElement("button");
        exportBtn.textContent = "Export Chat";
        exportBtn.onclick = () => {
            const data = Array.from(messagesList.querySelectorAll("li")).map(liItem => ({
                username: liItem.querySelector(".username")?.textContent || "",
                content: liItem.querySelector(".content")?.textContent || "",
                timestamp: liItem.querySelector(".timestamp")?.textContent || ""
            }));
            const blob = new Blob([JSON.stringify(data,null,2)], { type: "application/json" });
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "chat.json"; a.click();
            log("üì¶ Exported chat to chat.json", null, "info", "admin");
        };
        adminDiv.appendChild(exportBtn);
    
        // Mass delete by keyword
        const massDelBtn = document.createElement("button");
        massDelBtn.textContent = "Delete by Keyword";
        massDelBtn.onclick = async () => {
            const keyword = prompt("Enter keyword to delete:");
            if(!keyword) return;
            try {
                const { data } = await supabase.from("messages").select("*");
                const idsToDelete = (data||[]).filter(m => String(m.content||"").includes(keyword)).map(m=>m.id);
                if(idsToDelete.length) {
                    await supabase.from("messages").delete().in("id", idsToDelete);
                }
                Array.from(messagesList.querySelectorAll("li")).forEach(liItem=>{
                    if((liItem.querySelector(".content")?.textContent||"").includes(keyword)) liItem.remove();
                });
                log(`üßπ Deleted messages containing "${keyword}"`, null, "warn", "admin");
            } catch(e){ log("‚ùå Mass delete failed", e, "error", "admin"); }
        };
        adminDiv.appendChild(massDelBtn);
    
        // Delete User & Messages (NUKE)
        const nukeBtn = document.createElement("button");
        nukeBtn.textContent = "Delete User & Messages";
        nukeBtn.onclick = async () => {
            if (!confirm(`Are you sure you want to delete ${msg.username} and ALL their messages? This cannot be undone.`)) return;
            try {
                await supabase.from("messages").delete().eq("username", msg.username);
                const delUser = await supabase.from("users").delete().eq("username", msg.username);
                if(delUser.error) log("‚ö†Ô∏è Could not delete user row", delUser.error, "warn", "admin");
                document.querySelectorAll("#messages li").forEach(liItem=>{
                    if(liItem.querySelector(".username")?.textContent === msg.username) liItem.remove();
                });
                alert(`${msg.username} and all their messages have been deleted.`);
                log(`üóë Deleted all messages by ${msg.username}`, null, "warn", "admin");
            } catch(err){ log("‚ùå Failed to delete user and messages", err, "error", "admin"); alert("Error deleting user and messages. See log."); }
        };
        adminDiv.appendChild(nukeBtn);
    
        // User Info
        const infoBtn = document.createElement("button");
        infoBtn.textContent = "User Info";
        infoBtn.onclick = () => {
            alert(`Username: ${msg.username}\nIP: ${msg.ip}\nMessage ID: ${msg.id}\nRole: ${msg.role || "User"}`);
            log(`‚ÑπÔ∏è Shown info for ${msg.username}`, null, "debug", "admin");
        };
        adminDiv.appendChild(infoBtn);
    
        // Promote ‚Üí Manager
        const promoteBtn = document.createElement("button");
        promoteBtn.textContent = "Promote ‚Üí Manager";
        promoteBtn.onclick = async () => {
            try { await supabase.from("users").upsert({ username: msg.username, role: "Manager" }); log(`üëë Promoted ${msg.username} to Manager`, null, "info", "admin"); await loadMessages(); } catch(e){ log("‚ùå Promote failed", e, "error", "admin"); }
        };
        adminDiv.appendChild(promoteBtn);
    
        // Promote ‚Üí Admin
        const promoteAdminBtn = document.createElement("button");
        promoteAdminBtn.textContent = "Promote ‚Üí Admin";
        promoteAdminBtn.onclick = async () => {
            try { await supabase.from("users").upsert({ username: msg.username, role: "Admin" }); log(`üëë Promoted ${msg.username} to Admin`, null, "info", "admin"); await loadMessages(); } catch(e){ log("‚ùå Promote to Admin failed", e, "error", "admin"); }
        };
        adminDiv.appendChild(promoteAdminBtn);
    
        // Demote ‚Üí User
        const demoteBtn = document.createElement("button");
        demoteBtn.textContent = "Demote ‚Üí User";
        demoteBtn.onclick = async () => {
            try { await supabase.from("users").upsert({ username: msg.username, role: "User" }); log(`üîª Demoted ${msg.username} to User`, null, "info", "admin"); await loadMessages(); } catch(e){ log("‚ùå Demote failed", e, "error", "admin"); }
        };
        adminDiv.appendChild(demoteBtn);
    
        // Toggle visibility when message clicked
        li.addEventListener("click", (e) => { e.stopPropagation(); adminDiv.style.display = adminDiv.style.display === "none" ? "flex" : "none"; });
        document.addEventListener("click", ()=>{ adminDiv.style.display = "none"; });
    }
    
    /* ----------------------------------------------------------------------
       Shortcut: Ctrl+Shift+Alt+T to sign out (clear saved username)
       ---------------------------------------------------------------------- */
    document.addEventListener("keydown", (e)=>{
        if(e.ctrlKey && e.shiftKey && e.altKey && e.key.toLowerCase() === "t"){
            e.preventDefault();
            localStorage.removeItem("chatUsername");
            localStorage.removeItem("chatRole");
            location.reload();
        }
    });
    
    /* ----------------------------------------------------------------------
       Try to fetch IP (best-effort) ‚Äî not required, preserves original behavior
       ---------------------------------------------------------------------- */
    fetch("https://api.ipify.org?format=json").then(r=>r.json()).then(d=>{ userIp = d.ip; log("‚úÖ IP: "+userIp, null, "info", "network"); }).catch(()=>{ userIp = "unknown"; log("‚ùå Failed to get IP", null, "warn", "network"); });
    
// Check username on login
if (username.toLowerCase() === "takeo") {
    alert("You're not the admin!");
}
    </script>
</body>
</html>
