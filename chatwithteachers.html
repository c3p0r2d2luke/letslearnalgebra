<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:block; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script>
  /* ----------------------------------------------------------------------
     Chat App Core Setup
  ---------------------------------------------------------------------- */
  const input = document.getElementById("messageInput");
  const button = document.getElementById("sendButton");
  const messagesList = document.getElementById("messages");
  const logBox = document.getElementById("logBox");
  const namePrompt = document.getElementById("namePrompt");
  const nameInput = document.getElementById("nameInput");
  const saveNameBtn = document.getElementById("saveNameButton");
  
  const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M";
  
  let supabase;
  try {
    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    async function testSupabaseConnection() {
      try {
        const { data, error } = await supabase.from("messages").select("id").limit(1);
        if (error) log("âš ï¸ Supabase query failed â€” not connected to DB");
        else log("âœ… Supabase connection OK â€” messages table accessible ðŸ“¡");
      } catch (e) {
        log("âŒ Supabase connection error (check network or key)", e, "error");
      }
    }
    testSupabaseConnection();
  } catch (err) {
    console.warn("âš ï¸ Supabase not available.", err);
    log("âš ï¸ Running in online mode â€” Supabase connection failed");
  }
  
  /* ----------------------------------------------------------------------
     Username & Role
  ---------------------------------------------------------------------- */
  let username = localStorage.getItem("chatUsername") || "";
  let currentRole = localStorage.getItem("chatRole") || "User";
  
  async function saveName() {
    const name = nameInput.value.trim();
    if (!name) return alert("Please enter a name!");
    username = name;
    localStorage.setItem("chatUsername", name);
  
    if (supabase) {
      try {
        const { data, error } = await supabase.from("users")
          .select("role")
          .eq("username", name)
          .single();
        currentRole = (!error && data) ? data.role || "User" : "User";
      } catch {}
    } else currentRole = "User";
    localStorage.setItem("chatRole", currentRole);
  
    namePrompt.style.display = "none";
    input.disabled = false;
    button.disabled = false;
  
    await loadMessages();
  }
  saveNameBtn.onclick = saveName;
  
  if (username) {
    nameInput.value = username;
    currentRole = localStorage.getItem("chatRole") || "User";
    namePrompt.style.display = "none";
    input.disabled = false;
    button.disabled = false;
  }
  
  /* ----------------------------------------------------------------------
     Logging helper
  ---------------------------------------------------------------------- */
  function log(msg, obj = null, type = "info") {
    const el = document.createElement("div");
    el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logBox?.appendChild(el);
    logBox.scrollTop = logBox.scrollHeight;
    if (obj) console[type === "error" ? "error" : "log"](msg, obj);
  }
  
  /* ----------------------------------------------------------------------
     Messages Map (track for realtime updates)
  ---------------------------------------------------------------------- */
  const messagesMap = new Map();
  
  /* ----------------------------------------------------------------------
     Render a single message (used for realtime updates too)
  ---------------------------------------------------------------------- */
  function renderMessage(msg) {
    let li;
    if (messagesMap.has(msg.id)) {
      li = messagesMap.get(msg.id);
      li.querySelector(".content").textContent = msg.content;
    } else {
      li = document.createElement("li");
      li.dataset.id = msg.id;
  
      if (msg.role === "Admin") li.classList.add("admin");
      else if (msg.role === "Manager") li.classList.add("manager");
  
      const usernameDiv = document.createElement("div");
      usernameDiv.className = "username";
      usernameDiv.textContent = msg.username === "Frenchwizz" ? "Takeo" : msg.username;
      li.appendChild(usernameDiv);
  
      const contentDiv = document.createElement("div");
      contentDiv.className = "content";
      if (msg.role === "Admin") contentDiv.innerHTML = msg.content || "";
      else contentDiv.textContent = msg.content || "";
      li.appendChild(contentDiv);
  
      const adminDiv = document.createElement("div");
      adminDiv.className = "adminControls";
      adminDiv.style.display = "none";
  
      // --- Admin Controls ---
      if (currentRole === "Admin") {
        // Delete
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.onclick = async () => {
          if (li.dataset.pinned === "true") return alert("Cannot delete a pinned message!");
          try {
            await supabase.from("messages").delete().eq("id", msg.id);
            li.remove();
            messagesMap.delete(msg.id);
            log(`ðŸ—‘ Deleted message id=${msg.id}`);
          } catch (e) { log("âŒ Failed to delete message", e, "error"); }
        };
        adminDiv.appendChild(delBtn);
  
        // Edit
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.onclick = async () => {
          const newText = prompt("Edit message:", msg.content || "");
          if (newText === null) return;
          try {
            await supabase.from("messages").update({ content: newText }).eq("id", msg.id);
            msg.content = newText;
            renderMessage(msg);
            log(`âœï¸ Edited message id=${msg.id}`);
          } catch (e) { log("âŒ Exception editing message", e, "error"); }
        };
        adminDiv.appendChild(editBtn);
  
        // Pin / Unpin
        const pinBtn = document.createElement("button");
        pinBtn.textContent = msg.is_pinned ? "Unpin" : "Pin";
        if (msg.is_pinned) {
          li.dataset.pinned = "true";
          li.style.border = "2px solid red";
        }
        pinBtn.onclick = async () => {
          try {
            await supabase.from("messages").update({ is_pinned: !msg.is_pinned }).eq("id", msg.id);
            msg.is_pinned = !msg.is_pinned;
            li.dataset.pinned = msg.is_pinned ? "true" : "false";
            li.style.border = msg.is_pinned ? "2px solid red" : "";
            pinBtn.textContent = msg.is_pinned ? "Unpin" : "Pin";
            if (msg.is_pinned) messagesList.insertBefore(li, messagesList.firstChild);
            log(`${msg.is_pinned ? "ðŸ“Œ Pinned" : "âŒ Unpinned"} message id=${msg.id}`);
          } catch (e) { log("âŒ Failed to pin/unpin", e, "error"); }
        };
        adminDiv.appendChild(pinBtn);
  
        // Change Name
        const nameBtn = document.createElement("button");
        nameBtn.textContent = "Change Name";
        nameBtn.onclick = async () => {
          const newName = prompt("New username for " + msg.username + ":", msg.username);
          if (!newName) return;
          try {
            await supabase.from("users").upsert({ username: newName });
            await supabase.from("messages").update({ username: newName }).eq("username", msg.username);
            renderMessage({ ...msg, username: newName });
            log(`ðŸ” Changed username ${msg.username} â†’ ${newName}`);
          } catch (e) { log("âŒ Failed to change name", e, "error"); }
        };
        adminDiv.appendChild(nameBtn);
  
        // Force Logout
        const logoutBtn = document.createElement("button");
        logoutBtn.textContent = "Force Logout";
        logoutBtn.onclick = async () => {
          if (msg.username === username) return alert("Cannot force logout yourself.");
          try {
            await supabase.from("users").update({ forceLogout: true }).eq("username", msg.username);
            alert(`${msg.username} has been forced to log out.`);
            log(`ðŸ”Œ Forced logout for ${msg.username}`);
          } catch (e) { log("âŒ Failed to force logout", e, "error"); }
        };
        adminDiv.appendChild(logoutBtn);
  
        // Mute
        const muteBtn = document.createElement("button");
        muteBtn.textContent = "Mute 5min";
        muteBtn.onclick = () => {
          const mutedUsers = (window.__mutedUsers = window.__mutedUsers || {});
          mutedUsers[msg.username] = Date.now() + 5 * 60 * 1000;
          alert(`${msg.username} muted for 5 minutes`);
          log(`ðŸ”‡ Muted ${msg.username} for 5 minutes`);
        };
        adminDiv.appendChild(muteBtn);
  
        // Export Chat
        const exportBtn = document.createElement("button");
        exportBtn.textContent = "Export Chat";
        exportBtn.onclick = () => {
          const data = Array.from(messagesList.querySelectorAll("li")).map(liItem => ({
            username: liItem.querySelector(".username")?.textContent || "",
            content: liItem.querySelector(".content")?.textContent || ""
          }));
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "chat.json";
          a.click();
          log("ðŸ“¦ Exported chat");
        };
        adminDiv.appendChild(exportBtn);
      }
  
      // Admin panel toggle
      if (currentRole !== "User") {
        li.addEventListener("click", e => {
          e.stopPropagation();
          adminDiv.style.display = adminDiv.style.display === "none" ? "flex" : "none";
        });
        document.addEventListener("click", () => { adminDiv.style.display = "none"; });
      }
  
      li.appendChild(adminDiv);
      messagesList.appendChild(li);
      messagesMap.set(msg.id, li);
    }
  }
  
  function renderMessages(list) { list.forEach(msg => renderMessage(msg)); }
  
  /* ----------------------------------------------------------------------
     Load initial messages
  ---------------------------------------------------------------------- */
  async function loadMessages() {
    if (!supabase) return;
    try {
      const { data, error } = await supabase.from("messages").select("*").order("inserted_at", { ascending: true });
      if (error) return log("âŒ Failed to load messages", error, "error");
      if (data) renderMessages(data);
    } catch (e) { log("âŒ Exception loading messages", e, "error"); }
  }
  
  /* ----------------------------------------------------------------------
     Send message with IP logging
  ---------------------------------------------------------------------- */
  async function sendMessage() {
    const content = input.value.trim();
    if (!content || !username) return;
  
    try {
      // Get IP from external API
      const ipRes = await fetch("https://api.ipify.org?format=json");
      const ip = (await ipRes.json()).ip || "unknown";
  
      const { data, error } = await supabase.from("messages")
        .insert([{ username, content, role: currentRole, is_pinned: false, ip }])
        .select();
      if (!error && data.length) {
        input.value = "";
        log(`âœ… Message sent ðŸ“¡ (IP: ${ip})`);
      }
    } catch (e) { log("âŒ Failed to send message", e, "error"); }
  }
  
  button.addEventListener("click", sendMessage);
  input.addEventListener("keypress", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  /* ----------------------------------------------------------------------
     Supabase Realtime
  ---------------------------------------------------------------------- */
  if (supabase) {
    supabase.channel("public:messages")
      .on("postgres_changes", { event: "*", schema: "public", table: "messages" }, payload => {
        const msg = payload.new || payload.old;
        if (!msg) return;
        if (payload.eventType === "INSERT") renderMessage(msg);
        else if (payload.eventType === "UPDATE") renderMessage(msg);
        else if (payload.eventType === "DELETE") {
          const li = messagesMap.get(msg.id);
          if (li) {
            li.remove();
            messagesMap.delete(msg.id);
            log(`ðŸ—‘ Message deleted (realtime) id=${msg.id}`);
          }
        }
      })
      .subscribe();
    log("âœ… Subscribed to Supabase realtime updates ðŸ“¡");
  }
  
  /* ----------------------------------------------------------------------
     Initial load
  ---------------------------------------------------------------------- */
  document.addEventListener("DOMContentLoaded", () => {
    if (username) loadMessages();
    else {
      namePrompt.style.display = "block";
      input.disabled = true;
      button.disabled = true;
    }
  });
  </script>
  

</body>
</html>
