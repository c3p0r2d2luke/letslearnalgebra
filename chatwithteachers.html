<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:none; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#7289da; font-weight:700; color:#fff; }
#messages li.manager { background:#43b581; font-weight:700; color:#fff; }
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>
<div id="logBox"></div>

<script>
const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
const supabaseKey = "sb_publishable_7uXWpCRbMA4Zq-qiWz9Dmw__G1n8GIA";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let realtimeReady = false;
let username = localStorage.getItem("chatUsername") || "";
let currentRole = localStorage.getItem("chatRole") || "User";
let isAdmin = false;
let savedUsernameForAutoLogin = false;
let userIp = "";
let mutedUsers = {};

const input = document.getElementById("messageInput");
const button = document.getElementById("sendButton");
const messagesList = document.getElementById("messages");
const logBox = document.getElementById("logBox");
const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameButton");

function log(msg,obj=null,level="info",context=null){
    const now=new Date();
    const timestamp=`${now.toLocaleDateString()} ${now.toLocaleTimeString()}.${now.getMilliseconds()}`;
    const colors={info:"#0f0",warn:"#ff0",error:"#f00",debug:"#0ff"};
    const color=colors[level]||"#0f0";
    console.log(`[${timestamp}] ${level.toUpperCase()}${context?" ("+context+")":""}: ${msg}`,obj);
    if(!isAdmin) return;
    const entry=document.createElement("div");
    entry.style.marginBottom="6px";
    entry.style.borderBottom="1px solid #333";
    entry.style.paddingBottom="4px";
    entry.innerHTML=`<div><strong style="color:${color}">[${timestamp}] ${level.toUpperCase()}</strong>${context?`<em style="color:#aaa">(${context})</em>`:""}</div><div style="margin-left:8px">${String(msg)}</div>`;
    if(obj){ const pre=document.createElement("pre"); pre.textContent=JSON.stringify(obj,null,2); pre.style.background="#111"; pre.style.color="#0f0"; pre.style.padding="4px"; pre.style.borderRadius="4px"; pre.style.overflowX="auto"; pre.style.fontSize="11px"; pre.style.maxHeight="150px"; pre.style.overflowY="auto"; entry.appendChild(pre);}
    logBox.appendChild(entry);
    logBox.scrollTop = logBox.scrollHeight;
}

async function fetchOrCreateUserRecord(name){
    if(!name) return {username:name,role:"User"};
    try{
        const { data,error } = await supabase.from("users").select("username,role,blocked,forceLogout").eq("username",name).maybeSingle();
        if(error) log("❌ Error fetching user record",error,"error","users");
        if(data){ if(!data.role) data.role="User"; return data; }
        else{
            const up=await supabase.from("users").upsert({username:name,role:"User",blocked:false,forceLogout:false});
            if(up.error) log("❌ Error upserting default user",up.error,"error","users");
            return {username:name,role:"User",blocked:false,forceLogout:false};
        }
    }catch(e){ log("❌ Exception fetching/creating user",e,"error","users"); return {username:name,role:"User"}; }
}

async function saveName(){
    const val=nameInput.value.trim();
    if(!val) return alert("Name required!");
    username=val;
    const userRecord = await fetchOrCreateUserRecord(username);
    currentRole = userRecord.role || "User";
    localStorage.setItem("chatUsername",username);
    localStorage.setItem("chatRole",currentRole);
    if((username.toLowerCase()==="frenchwizz")||currentRole==="Admin"){ isAdmin=true; logBox.style.display="block"; log("Logged in as ADMIN.",null,"info","auth"); }
    namePrompt.style.display="none";
    input.disabled=false;
    button.disabled=false;
    savedUsernameForAutoLogin=true;
    await loadMessages();
}

saveNameBtn.onclick=saveName;

// --- Load messages, subscribe, send message etc. ---
// Everything else remains exactly as in your original code
// (Realtime subscription, message filtering, admin tools, keyboard shortcuts)

</script>
</body>
</html>
