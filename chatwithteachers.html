<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chat With Teachers</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:800px; margin:24px auto; padding:0 16px; background:#2f3136; color:#ddd; }
#logBox { background:#111; color:#0f0; font-family:monospace; font-size:13px; padding:10px; height:180px; overflow-y:auto; margin-top:12px; border-radius:6px; display:block; }
#messages { margin-top:12px; padding:0; list-style:none; font-family:sans-serif; }
#messages li { background:#36393f; margin:6px 0; padding:8px 10px; border-radius:6px; display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-direction:column; position:relative; transition: background 0.2s ease; }
#messages li.admin { background:#5865f2; font-weight:700; color:#fff; } /* Discord blue */
#messages li.manager { background:#2d7d46; font-weight:700; color:#fff; } /* Discord dark green */
#messages li .username { font-weight:700; cursor:pointer; display:flex; gap:4px; align-items:center; }
#messages li .content { white-space:pre-wrap; word-break:break-word; }
#messages li button { margin:2px 2px 0 0; font-size:12px; padding:4px 6px; border-radius:4px; border:1px solid #ccc; background:#7289da; color:#fff; cursor:pointer; }
#messages li button:hover { background:#5b6eae; }
textarea { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; resize:vertical; min-height:48px; width:100%; }
button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
#controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
.userIp { font-size:10px; color:#888; margin-left:6px; }
.adminControls { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
li.highlighted { background-color: #4f545c !important; }
</style>
</head>
<body>
<h1>Chat Room</h1>

<div id="namePrompt" style="margin-bottom:10px;">
    <input id="nameInput" placeholder="Enter your real name, or you will be banned..." />
    <button id="saveNameButton">Save Name</button>
</div>

<div id="controls">
    <textarea id="messageInput" placeholder="Type a message..." disabled></textarea>
    <button id="sendButton" disabled>Send</button>
</div>

<ul id="messages"></ul>

<div id="logBox"></div>

<script>
  const input = document.getElementById("messageInput");
  const button = document.getElementById("sendButton");
  const messagesList = document.getElementById("messages");
  const logBox = document.getElementById("logBox");
logBox.style.display = "none";
  const namePrompt = document.getElementById("namePrompt");
  const nameInput = document.getElementById("nameInput");
  const saveNameBtn = document.getElementById("saveNameButton");
  
// ------------------------ Disable chat until name saved ------------------------
const savedName = localStorage.getItem("chatUsername");

if (!savedName) {
  // No name saved, lock chat until user saves name
  input.disabled = true;
  button.disabled = true;
  namePrompt.style.display = "block";
} else {
  // Name already saved, unlock chat
  username = savedName;
  input.disabled = false;
  button.disabled = false;
  namePrompt.style.display = "none";
}


  const supabaseUrl = "https://qjajtkdchvapthnidtwj.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqYWp0a2RjaHZhcHRobmlkdHdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTI4MDgsImV4cCI6MjA3Mzc4ODgwOH0.BYyhualVRAOqctt8u3flAH9PHKaAV8bedV8JeaYjf7M"; // replace with your key
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
  
  let username = localStorage.getItem("chatUsername") || "";
  let currentRole = localStorage.getItem("chatRole") || "User";
  
  const messagesMap = new Map(); // track DOM elements by msg.id
  
  // ------------------------ Logging ------------------------
  function log(msg, obj = null, type = "info") {
    const el = document.createElement("div");
    el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logBox.appendChild(el);
    logBox.scrollTop = logBox.scrollHeight;
    if (obj) console[type === "error" ? "error" : "log"](msg, obj);
  }
  
// ------------------------ Save Name ------------------------
async function saveName() {
  const name = nameInput.value.trim();

  if (!name) {
    alert("Please enter your name before continuing!");
    return;
  }

  username = name;
  localStorage.setItem("chatUsername", name);

  try {
    const { data, error } = await supabase
      .from("users")
      .select("role")
      .eq("username", name)
      .single();

    currentRole = (!error && data?.role) ? data.role : "User";
    localStorage.setItem("chatRole", currentRole);
  } catch (err) {
    console.error("Error fetching role:", err);
    currentRole = "User";
    localStorage.setItem("chatRole", "User");
  }

  // âœ… Hide name prompt and unlock chat
  namePrompt.style.display = "none";
  input.disabled = false;
  button.disabled = false;

  // âœ… Reload messages for this user
  loadMessages();

  // âœ… Show admin log only if Admin
  if (currentRole === "Admin") {
    logBox.style.display = "block";
  } else {
    logBox.style.display = "none";
  }

  // âœ… Recheck input lock state (optional helper)
  if (typeof updateMessageLock === "function") updateMessageLock();

  alert(`Welcome, ${name}! You can now chat as ${currentRole}.`);
}

// Attach handler
saveNameBtn.onclick = saveName;


// ------------------------ Auto-load saved name ------------------------
if (username) {
  nameInput.value = username;          // prefill saved name
  namePrompt.style.display = "none";   // hide name prompt
  input.disabled = false;
  button.disabled = false;
  loadMessages();

  // âœ… Show log box only for Admins
  if (currentRole === "Admin") {
    logBox.style.display = "block";
  } else {
    logBox.style.display = "none";
  }
} else {
  // no name yet â€” keep name box visible and disable inputs
  input.disabled = true;
  button.disabled = true;
  updateMessageLock();
}



  
  // ------------------------ Send Message ------------------------
  async function sendMessage() {
    const content = input.value.trim();
    if (!content || !username) return;
  
    let ip = "unknown";
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      ip = data.ip || "unknown";
    } catch {}
  
    try {
      const { data, error } = await supabase.from("messages")
        .insert([{ username, content, role: currentRole, is_pinned: false, ip }])
        .select();
      if (!error) {
        input.value = "";
        log("âœ… Message sent to Supabase");
      }
    } catch (e) {
      log("âŒ Failed to send message", e, "error");
    }
  }
  
  button.addEventListener("click", sendMessage);
  input.addEventListener("keypress", e => { if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMessage(); }});
  
  // ------------------------ Render Message ------------------------
  function renderMessage(msg) {
    let li = messagesMap.get(msg.id);
    const viewerRole = currentRole;
  
    if (!li) {
      li = document.createElement("li");
      messagesMap.set(msg.id, li);
      messagesList.appendChild(li);
    }
  
    li.innerHTML = "";
        // âœ… Apply role-specific colors
        li.className = ""; // clear any old role classes
    if (msg.role === "Admin") li.classList.add("admin");
    else if (msg.role === "Manager") li.classList.add("manager");
    li.dataset.pinned = msg.is_pinned ? "true" : "false";
    if (msg.is_pinned) li.style.border = "2px solid red"; else li.style.border = "";
  
    // Username
    const uname = document.createElement("div");
    uname.className = "username";
    uname.textContent = msg.username === "Frenchwizz" ? "Takeo" : msg.username;
    li.appendChild(uname);
  
    // Message content
    const contentDiv = document.createElement("div");
    contentDiv.className = "content";
    if (msg.role === "Admin") contentDiv.innerHTML = msg.content;
    else contentDiv.textContent = msg.content;
    li.appendChild(contentDiv);
  
    // Admin panel
    const adminDiv = document.createElement("div");
    adminDiv.className = "adminControls";
    adminDiv.style.display = "none";
  
    // ----- ADMIN BUTTONS -----
    if (viewerRole === "Admin") {
      // Delete
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.onclick = async () => {
        if (li.dataset.pinned === "true") return alert("Cannot delete pinned!");
        await supabase.from("messages").delete().eq("id", msg.id);
        li.remove(); messagesMap.delete(msg.id);
        log(`ðŸ—‘ Deleted msg id=${msg.id}`);
      };
      adminDiv.appendChild(delBtn);
  
      // Edit
      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.onclick = async () => {
        const newText = prompt("Edit message:", msg.content || "");
        if (newText === null) return;
        await supabase.from("messages").update({ content: newText }).eq("id", msg.id);
        msg.content = newText;
        renderMessage(msg);
        log(`âœï¸ Edited msg id=${msg.id}`);
      };
      adminDiv.appendChild(editBtn);
  
      // Pin / Unpin
      const pinBtn = document.createElement("button");
      pinBtn.textContent = msg.is_pinned ? "Unpin" : "Pin";
      pinBtn.onclick = async () => {
        await supabase.from("messages").update({ is_pinned: !msg.is_pinned }).eq("id", msg.id);
        msg.is_pinned = !msg.is_pinned;
        renderMessage(msg);
        log(`${msg.is_pinned ? "ðŸ“Œ Pinned" : "âŒ Unpinned"} msg id=${msg.id}`);
      };
      adminDiv.appendChild(pinBtn);
  
      // User Info
      const infoBtn = document.createElement("button");
      infoBtn.textContent = "User Info";
      infoBtn.onclick = () => alert(`Username: ${msg.username}\nIP: ${msg.ip}\nRole: ${msg.role}`);
      adminDiv.appendChild(infoBtn);
  
      // Mute 5min
      const muteBtn = document.createElement("button");
      muteBtn.textContent = "Mute 5min";
      muteBtn.onclick = () => {
        window.__mutedUsers = window.__mutedUsers || {};
        window.__mutedUsers[msg.username] = Date.now() + 5*60*1000;
        alert(`${msg.username} muted for 5 min`);
      };
      adminDiv.appendChild(muteBtn);
  
      // Export chat
      const exportBtn = document.createElement("button");
      exportBtn.textContent = "Export Chat";
      exportBtn.onclick = () => {
        const data = Array.from(messagesList.querySelectorAll("li")).map(liItem => ({
          username: liItem.querySelector(".username")?.textContent || "",
          content: liItem.querySelector(".content")?.textContent || "",
        }));
        const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="chat.json"; a.click();
      };
      adminDiv.appendChild(exportBtn);
  
      // Promote / Demote
      const promoteBtn = document.createElement("button");
      promoteBtn.textContent = "Promote â†’ Manager";
      promoteBtn.onclick = async () => { await supabase.from("users").upsert({ username: msg.username, role:"Manager" }); log(`Promoted ${msg.username}`); };
      adminDiv.appendChild(promoteBtn);
      const promoteAdminBtn = document.createElement("button");
      promoteAdminBtn.textContent = "Promote â†’ Admin";
      promoteAdminBtn.onclick = async () => { await supabase.from("users").upsert({ username: msg.username, role:"Admin" }); log(`Promoted ${msg.username} to Admin`); };
      adminDiv.appendChild(promoteAdminBtn);
      const demoteBtn = document.createElement("button");
      demoteBtn.textContent = "Demote â†’ User";
      demoteBtn.onclick = async () => { await supabase.from("users").upsert({ username: msg.username, role:"User" }); log(`Demoted ${msg.username}`); };
      adminDiv.appendChild(demoteBtn);
  
      // Delete User & Messages (NUKE)
      const nukeBtn = document.createElement("button");
      nukeBtn.textContent = "Delete User & Messages";
      nukeBtn.onclick = async () => {
        if(!confirm(`Delete ${msg.username} and ALL messages?`)) return;
        await supabase.from("messages").delete().eq("username", msg.username);
        await supabase.from("users").delete().eq("username", msg.username);
        messagesMap.forEach((el,mId)=>{ if(el.querySelector(".username")?.textContent===msg.username) { el.remove(); messagesMap.delete(mId); }});
        log(`ðŸ—‘ Nuked user ${msg.username}`);
      };
      adminDiv.appendChild(nukeBtn);
    }
  
    li.appendChild(adminDiv);
  
    // Toggle admin panel
    if(viewerRole !== "User"){
      li.addEventListener("click", e => { e.stopPropagation(); adminDiv.style.display = adminDiv.style.display==="none"?"flex":"none"; });
      document.addEventListener("click", ()=>{ adminDiv.style.display="none"; });
    }
  }
  
  // ------------------------ Load Messages Realtime ------------------------
  async function loadMessages() {
    const { data, error } = await supabase.from("messages").select("*").order("inserted_at",{ascending:true});
    if(error){ log("âŒ Failed to load messages", error,"error"); return; }
    data.forEach(msg => renderMessage(msg));
    log("âœ… Messages loaded");
  }
  
// ------------------------ Supabase Live Subscription ------------------------
const channel = supabase.channel("messages-channel")
  .on("postgres_changes", { event: "*", schema: "public", table: "messages" }, (payload) => {
    log(`ðŸ“¡ Live update received (${payload.eventType})`);
    handleRealtimeMessage(payload.new || payload.record, payload.eventType);
  })
  .subscribe((status) => {
    if (status === "SUBSCRIBED") log("âœ… Subscribed to Supabase live updates");
    else if (status === "CLOSED") log("ðŸ”´ Supabase connection closed");
    else if (status === "CHANNEL_ERROR") log("âš ï¸ Supabase live channel error");
  });

// ------------------------ Realtime Message Handler ------------------------
function handleRealtimeMessage(newMsg, eventType) {
  if (!newMsg) return;

  if (eventType === "INSERT") {
    renderMessage(newMsg);
  } else if (eventType === "UPDATE") {
    renderMessage(newMsg);
  } else if (eventType === "DELETE") {
    const existing = messagesMap.get(newMsg.id);
    if (existing) {
      existing.remove();
      messagesMap.delete(newMsg.id);
    }
  }
}

// ------------------------ Name Lock Feature ------------------------
const messageInput = document.getElementById("messageInput");
const sendButton = document.getElementById("sendButton");

// disable message box + send until name is typed
function updateMessageLock() {
  const hasName = nameInput.value.trim().length > 0;
  messageInput.disabled = !hasName;
  sendButton.disabled = !hasName;
}

nameInput.addEventListener("input", updateMessageLock);
updateMessageLock(); // run once on page load
  

// ------------------------ Secret Sign-Out Shortcut ------------------------
document.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.altKey && e.shiftKey && e.key.toLowerCase() === "t") {
    e.preventDefault();
    localStorage.removeItem("chatUsername");
    localStorage.removeItem("chatRole");

    alert("ðŸ‘‹ You have been signed out!");
    namePrompt.style.display = "block";
    input.disabled = true;
    button.disabled = true;
    nameInput.value = "";
    currentRole = null;

    if (logBox) logBox.style.display = "none";

    updateMessageLock(); // âœ… locks chat again
    saveNameBtn.onclick = saveName; // âœ… reconnects the save button
  }
});





</script>
  
  

</body>
</html>
